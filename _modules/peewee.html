
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>peewee &#8212; darc 0.9.2 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for peewee</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect_left</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect_right</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Mapping</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pysqlite3</span> <span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">pysq3</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pysqlite2</span> <span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">pysq3</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">pysq3</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">sqlite3</span> <span class="o">=</span> <span class="n">pysq3</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">pysq3</span> <span class="ow">and</span> <span class="n">pysq3</span><span class="o">.</span><span class="n">sqlite_version_info</span> <span class="o">&gt;=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">sqlite_version_info</span><span class="p">:</span>
        <span class="n">sqlite3</span> <span class="o">=</span> <span class="n">pysq3</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">psycopg2cffi</span> <span class="kn">import</span> <span class="n">compat</span>
    <span class="n">compat</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">psycopg2</span>
    <span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">extensions</span> <span class="k">as</span> <span class="n">pg_extensions</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">pg_errors</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">pg_errors</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">psycopg2</span> <span class="o">=</span> <span class="n">pg_errors</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">mysql_passwd</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pymysql</span> <span class="k">as</span> <span class="nn">mysql</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">MySQLdb</span> <span class="k">as</span> <span class="nn">mysql</span>
        <span class="n">mysql_passwd</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">mysql</span> <span class="o">=</span> <span class="kc">None</span>


<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;3.14.0&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;AsIs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AutoField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BareField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BigAutoField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BigBitField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BigIntegerField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BinaryUUIDField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BitField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BlobField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BooleanField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Case&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cast&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CharField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Check&#39;</span><span class="p">,</span>
    <span class="s1">&#39;chunked&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Column&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CompositeKey&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Context&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Database&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DatabaseError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DatabaseProxy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DataError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DateField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DateTimeField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DecimalField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DeferredForeignKey&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DeferredThroughModel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DJANGO_MAP&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DoesNotExist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DoubleField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DQ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EXCLUDED&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Field&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FixedCharField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FloatField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fn&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ForeignKeyField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IdentityField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ImproperlyConfigured&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Index&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IntegerField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IntegrityError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;InterfaceError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;InternalError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IPField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;JOIN&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ManyToManyField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ModelIndex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MySQLDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NotSupportedError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OP&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OperationalError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PostgresqlDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PrimaryKeyField&#39;</span><span class="p">,</span>  <span class="c1"># XXX: Deprecated, change to AutoField.</span>
    <span class="s1">&#39;prefetch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ProgrammingError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Proxy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;QualifiedNames&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SchemaManager&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SmallIntegerField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Select&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SQL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SqliteDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Table&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TextField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TimeField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TimestampField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tuple&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UUIDField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Value&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ValuesList&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Window&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># Python 2.7+</span>
    <span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">NullHandler</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">NullHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
            <span class="k">pass</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;peewee&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">NullHandler</span><span class="p">())</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">text_type</span> <span class="o">=</span> <span class="n">unicode</span>
    <span class="n">bytes_type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">buffer_type</span> <span class="o">=</span> <span class="n">buffer</span>
    <span class="n">izip_longest</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip_longest</span>
    <span class="n">callable_</span> <span class="o">=</span> <span class="n">callable</span>
    <span class="n">multi_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">,</span> <span class="nb">set</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;def reraise(tp, value, tb=None): raise tp, value, tb&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">print_</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">builtins</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Callable</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
    <span class="n">callable_</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Callable</span><span class="p">)</span>
    <span class="n">text_type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">bytes_type</span> <span class="o">=</span> <span class="nb">bytes</span>
    <span class="n">buffer_type</span> <span class="o">=</span> <span class="nb">memoryview</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">multi_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">range</span><span class="p">)</span>
    <span class="n">print_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">)</span>
    <span class="n">izip_longest</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span>
    <span class="k">def</span> <span class="nf">reraise</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">__traceback__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">tb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">value</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">value</span>


<span class="k">if</span> <span class="n">sqlite3</span><span class="p">:</span>
    <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">__sqlite_version__</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">sqlite_version_info</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">__sqlite_version__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="n">__date_parts__</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">))</span>

<span class="c1"># Sqlite does not support the `date_part` SQL function, so we will define an</span>
<span class="c1"># implementation in python.</span>
<span class="n">__sqlite_datetime_formats__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>

<span class="n">__sqlite_date_trunc__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-01-01 00:00:00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-01 00:00:00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> 00:00:00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:00:00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;minute&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">}</span>

<span class="n">__mysql_date_trunc__</span> <span class="o">=</span> <span class="n">__sqlite_date_trunc__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">__mysql_date_trunc__</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:</span><span class="si">%i</span><span class="s1">:00&#39;</span>
<span class="n">__mysql_date_trunc__</span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:</span><span class="si">%i</span><span class="s1">:%S&#39;</span>

<span class="k">def</span> <span class="nf">_sqlite_date_part</span><span class="p">(</span><span class="n">lookup_type</span><span class="p">,</span> <span class="n">datetime_string</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">lookup_type</span> <span class="ow">in</span> <span class="n">__date_parts__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">datetime_string</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">datetime_string</span><span class="p">,</span> <span class="n">__sqlite_datetime_formats__</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">lookup_type</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_sqlite_date_trunc</span><span class="p">(</span><span class="n">lookup_type</span><span class="p">,</span> <span class="n">datetime_string</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">lookup_type</span> <span class="ow">in</span> <span class="n">__sqlite_date_trunc__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">datetime_string</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">datetime_string</span><span class="p">,</span> <span class="n">__sqlite_datetime_formats__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">__sqlite_date_trunc__</span><span class="p">[</span><span class="n">lookup_type</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">__deprecated__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">attrdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span> <span class="n">d</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">(</span><span class="bp">self</span><span class="p">);</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span> <span class="k">return</span> <span class="n">d</span>

<span class="n">SENTINEL</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="c1">#: Operations for use in SQL expressions.</span>
<span class="n">OP</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">(</span>
    <span class="n">AND</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span>
    <span class="n">OR</span><span class="o">=</span><span class="s1">&#39;OR&#39;</span><span class="p">,</span>
    <span class="n">ADD</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
    <span class="n">SUB</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
    <span class="n">MUL</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
    <span class="n">DIV</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span>
    <span class="n">BIN_AND</span><span class="o">=</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
    <span class="n">BIN_OR</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span>
    <span class="n">XOR</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span>
    <span class="n">MOD</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">,</span>
    <span class="n">EQ</span><span class="o">=</span><span class="s1">&#39;=&#39;</span><span class="p">,</span>
    <span class="n">LT</span><span class="o">=</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
    <span class="n">LTE</span><span class="o">=</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
    <span class="n">GT</span><span class="o">=</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
    <span class="n">GTE</span><span class="o">=</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
    <span class="n">NE</span><span class="o">=</span><span class="s1">&#39;!=&#39;</span><span class="p">,</span>
    <span class="n">IN</span><span class="o">=</span><span class="s1">&#39;IN&#39;</span><span class="p">,</span>
    <span class="n">NOT_IN</span><span class="o">=</span><span class="s1">&#39;NOT IN&#39;</span><span class="p">,</span>
    <span class="n">IS</span><span class="o">=</span><span class="s1">&#39;IS&#39;</span><span class="p">,</span>
    <span class="n">IS_NOT</span><span class="o">=</span><span class="s1">&#39;IS NOT&#39;</span><span class="p">,</span>
    <span class="n">LIKE</span><span class="o">=</span><span class="s1">&#39;LIKE&#39;</span><span class="p">,</span>
    <span class="n">ILIKE</span><span class="o">=</span><span class="s1">&#39;ILIKE&#39;</span><span class="p">,</span>
    <span class="n">BETWEEN</span><span class="o">=</span><span class="s1">&#39;BETWEEN&#39;</span><span class="p">,</span>
    <span class="n">REGEXP</span><span class="o">=</span><span class="s1">&#39;REGEXP&#39;</span><span class="p">,</span>
    <span class="n">IREGEXP</span><span class="o">=</span><span class="s1">&#39;IREGEXP&#39;</span><span class="p">,</span>
    <span class="n">CONCAT</span><span class="o">=</span><span class="s1">&#39;||&#39;</span><span class="p">,</span>
    <span class="n">BITWISE_NEGATION</span><span class="o">=</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>

<span class="c1"># To support &quot;django-style&quot; double-underscore filters, create a mapping between</span>
<span class="c1"># operation name and operation code, e.g. &quot;__eq&quot; == OP.EQ.</span>
<span class="n">DJANGO_MAP</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">({</span>
    <span class="s1">&#39;eq&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
    <span class="s1">&#39;lt&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span>
    <span class="s1">&#39;lte&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
    <span class="s1">&#39;gt&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
    <span class="s1">&#39;gte&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
    <span class="s1">&#39;ne&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ne</span><span class="p">,</span>
    <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">lshift</span><span class="p">,</span>
    <span class="s1">&#39;is&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Expression</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span>
    <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Expression</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">LIKE</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span>
    <span class="s1">&#39;ilike&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Expression</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span>
    <span class="s1">&#39;regexp&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Expression</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">REGEXP</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span>
<span class="p">})</span>

<span class="c1">#: Mapping of field type to the data-type supported by the database. Databases</span>
<span class="c1">#: may override or add to this list.</span>
<span class="n">FIELD</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">(</span>
    <span class="n">AUTO</span><span class="o">=</span><span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
    <span class="n">BIGAUTO</span><span class="o">=</span><span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span>
    <span class="n">BIGINT</span><span class="o">=</span><span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span>
    <span class="n">BLOB</span><span class="o">=</span><span class="s1">&#39;BLOB&#39;</span><span class="p">,</span>
    <span class="n">BOOL</span><span class="o">=</span><span class="s1">&#39;SMALLINT&#39;</span><span class="p">,</span>
    <span class="n">CHAR</span><span class="o">=</span><span class="s1">&#39;CHAR&#39;</span><span class="p">,</span>
    <span class="n">DATE</span><span class="o">=</span><span class="s1">&#39;DATE&#39;</span><span class="p">,</span>
    <span class="n">DATETIME</span><span class="o">=</span><span class="s1">&#39;DATETIME&#39;</span><span class="p">,</span>
    <span class="n">DECIMAL</span><span class="o">=</span><span class="s1">&#39;DECIMAL&#39;</span><span class="p">,</span>
    <span class="n">DEFAULT</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">DOUBLE</span><span class="o">=</span><span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
    <span class="n">FLOAT</span><span class="o">=</span><span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
    <span class="n">INT</span><span class="o">=</span><span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
    <span class="n">SMALLINT</span><span class="o">=</span><span class="s1">&#39;SMALLINT&#39;</span><span class="p">,</span>
    <span class="n">TEXT</span><span class="o">=</span><span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
    <span class="n">TIME</span><span class="o">=</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span>
    <span class="n">UUID</span><span class="o">=</span><span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
    <span class="n">UUIDB</span><span class="o">=</span><span class="s1">&#39;BLOB&#39;</span><span class="p">,</span>
    <span class="n">VARCHAR</span><span class="o">=</span><span class="s1">&#39;VARCHAR&#39;</span><span class="p">)</span>

<span class="c1">#: Join helpers (for convenience) -- all join types are supported, this object</span>
<span class="c1">#: is just to help avoid introducing errors by using strings everywhere.</span>
<span class="n">JOIN</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">(</span>
    <span class="n">INNER</span><span class="o">=</span><span class="s1">&#39;INNER JOIN&#39;</span><span class="p">,</span>
    <span class="n">LEFT_OUTER</span><span class="o">=</span><span class="s1">&#39;LEFT OUTER JOIN&#39;</span><span class="p">,</span>
    <span class="n">RIGHT_OUTER</span><span class="o">=</span><span class="s1">&#39;RIGHT OUTER JOIN&#39;</span><span class="p">,</span>
    <span class="n">FULL</span><span class="o">=</span><span class="s1">&#39;FULL JOIN&#39;</span><span class="p">,</span>
    <span class="n">FULL_OUTER</span><span class="o">=</span><span class="s1">&#39;FULL OUTER JOIN&#39;</span><span class="p">,</span>
    <span class="n">CROSS</span><span class="o">=</span><span class="s1">&#39;CROSS JOIN&#39;</span><span class="p">,</span>
    <span class="n">NATURAL</span><span class="o">=</span><span class="s1">&#39;NATURAL JOIN&#39;</span><span class="p">,</span>
    <span class="n">LATERAL</span><span class="o">=</span><span class="s1">&#39;LATERAL&#39;</span><span class="p">,</span>
    <span class="n">LEFT_LATERAL</span><span class="o">=</span><span class="s1">&#39;LEFT JOIN LATERAL&#39;</span><span class="p">)</span>

<span class="c1"># Row representations.</span>
<span class="n">ROW</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">(</span>
    <span class="n">TUPLE</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">DICT</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">NAMED_TUPLE</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">CONSTRUCTOR</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">MODEL</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">SCOPE_NORMAL</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">SCOPE_SOURCE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SCOPE_VALUES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">SCOPE_CTE</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">SCOPE_COLUMN</span> <span class="o">=</span> <span class="mi">16</span>

<span class="c1"># Rules for parentheses around subqueries in compound select.</span>
<span class="n">CSQ_PARENTHESES_NEVER</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">CSQ_PARENTHESES_ALWAYS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">CSQ_PARENTHESES_UNNESTED</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Regular expressions used to convert class names to snake-case table names.</span>
<span class="c1"># First regex handles acronym followed by word or initial lower-word followed</span>
<span class="c1"># by a capitalized word. e.g. APIResponse -&gt; API_Response / fooBar -&gt; foo_Bar.</span>
<span class="c1"># Second regex handles the normal case of two title-cased words.</span>
<span class="n">SNAKE_CASE_STEP1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;(.)_*([A-Z][a-z]+)&#39;</span><span class="p">)</span>
<span class="n">SNAKE_CASE_STEP2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;([a-z0-9])_*([A-Z])&#39;</span><span class="p">)</span>

<span class="c1"># Helper functions that are used in various parts of the codebase.</span>
<span class="n">MODEL_BASE</span> <span class="o">=</span> <span class="s1">&#39;_metaclass_helper_&#39;</span>

<span class="k">def</span> <span class="nf">with_metaclass</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">meta</span><span class="p">(</span><span class="n">MODEL_BASE</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span><span class="p">,),</span> <span class="p">{})</span>

<span class="k">def</span> <span class="nf">merge_dict</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">overrides</span><span class="p">):</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">overrides</span><span class="p">:</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged</span>

<span class="k">def</span> <span class="nf">quote</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quote_chars</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_chars</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">part</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>

<span class="n">is_model</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">isclass</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_tuple</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>

<span class="k">def</span> <span class="nf">ensure_entity</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="k">else</span> <span class="n">Entity</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_snake_case</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">SNAKE_CASE_STEP1</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\1_\2&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SNAKE_CASE_STEP2</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\1_\2&#39;</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">chunked</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">izip_longest</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">it</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span>
                                                <span class="n">fillvalue</span><span class="o">=</span><span class="n">marker</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="n">marker</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">marker</span><span class="p">):]</span>
        <span class="k">yield</span> <span class="n">group</span>


<span class="k">class</span> <span class="nc">_callable_context_manager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>


<span class="k">class</span> <span class="nc">Proxy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a proxy or placeholder for another object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;obj&#39;</span><span class="p">,</span> <span class="s1">&#39;_callbacks&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">attach_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">def</span> <span class="nf">passthrough</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot use uninitialized Proxy.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>

    <span class="c1"># Allow proxy to be used as a context-manager.</span>
    <span class="fm">__enter__</span> <span class="o">=</span> <span class="n">passthrough</span><span class="p">(</span><span class="s1">&#39;__enter__&#39;</span><span class="p">)</span>
    <span class="fm">__exit__</span> <span class="o">=</span> <span class="n">passthrough</span><span class="p">(</span><span class="s1">&#39;__exit__&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot use uninitialized Proxy.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot set attribute on proxy.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Proxy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DatabaseProxy</span><span class="p">(</span><span class="n">Proxy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Proxy implementation specifically for proxying `Database` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">connection_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">manual_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ModelDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span>


<span class="c1"># SQL Generation.</span>


<span class="k">class</span> <span class="nc">AliasManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_counter&#39;</span><span class="p">,</span> <span class="s1">&#39;_current_index&#39;</span><span class="p">,</span> <span class="s1">&#39;_mapping&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># A list of dictionaries containing mappings at various depths.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;t</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">any_depth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">any_depth</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_index</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">source</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot pop() from empty alias manager.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_index</span> <span class="o">-=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;_State&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">,</span> <span class="s1">&#39;parentheses&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;settings&#39;</span><span class="p">))):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">SCOPE_NORMAL</span><span class="p">,</span> <span class="n">parentheses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">parentheses</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parentheses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Scope and settings are &quot;inherited&quot; (parentheses is not, however).</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">scope</span>

        <span class="c1"># Try to avoid unnecessary dict copying.</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Copy original settings dict.</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># Update copy with overrides.</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span>
        <span class="k">return</span> <span class="n">State</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">parentheses</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__scope_context__</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">inner</span>


<span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;stack&#39;</span><span class="p">,</span> <span class="s1">&#39;_sql&#39;</span><span class="p">,</span> <span class="s1">&#39;_values&#39;</span><span class="p">,</span> <span class="s1">&#39;alias_manager&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_manager</span> <span class="o">=</span> <span class="n">AliasManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Context</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">column_sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">scope</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parentheses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">parentheses</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subquery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">subquery</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">overrides</span> <span class="ow">and</span> <span class="n">overrides</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">overrides</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="o">**</span><span class="n">overrides</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">scope_normal</span> <span class="o">=</span> <span class="n">__scope_context__</span><span class="p">(</span><span class="n">SCOPE_NORMAL</span><span class="p">)</span>
    <span class="n">scope_source</span> <span class="o">=</span> <span class="n">__scope_context__</span><span class="p">(</span><span class="n">SCOPE_SOURCE</span><span class="p">)</span>
    <span class="n">scope_values</span> <span class="o">=</span> <span class="n">__scope_context__</span><span class="p">(</span><span class="n">SCOPE_VALUES</span><span class="p">)</span>
    <span class="n">scope_cte</span> <span class="o">=</span> <span class="n">__scope_context__</span><span class="p">(</span><span class="n">SCOPE_CTE</span><span class="p">)</span>
    <span class="n">scope_column</span> <span class="o">=</span> <span class="n">__scope_context__</span><span class="p">(</span><span class="n">SCOPE_COLUMN</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentheses</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentheses</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">push_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_manager</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_manager</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">Context</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_model</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Value</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">literal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_param</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">converter</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">converter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">converter</span><span class="p">:</span>
            <span class="c1"># Explicitly check for None so that &quot;False&quot; can be used to signify</span>
            <span class="c1"># that no conversion should be applied.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">converter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="p">(</span><span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_model</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="c1"># Under certain circumstances, we could end-up treating a model-</span>
            <span class="c1"># class itself as a value. This check ensures that we drop the</span>
            <span class="c1"># table alias into the query instead of trying to parameterize a</span>
            <span class="c1"># model (for instance, passing a model as a function argument).</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope_column</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">param</span> <span class="ow">or</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">add_param</span> <span class="k">else</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">_sql</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span>


<span class="k">def</span> <span class="nf">query_to_string</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="c1"># NOTE: this function is not exported by default as it might be misused --</span>
    <span class="c1"># and this misuse could lead to sql injection vulnerabilities. This</span>
    <span class="c1"># function is intended for debugging or logging purposes ONLY.</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;_database&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_sql_context</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>

    <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sql</span>

    <span class="n">param</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">param</span> <span class="ow">or</span> <span class="s1">&#39;?&#39;</span>
    <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sql</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_query_val_transform</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_query_val_transform</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="c1"># Interpolate parameters.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">text_type</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                      <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">)):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">v</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;raw_unicode_escape&#39;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">v</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>  <span class="c1"># Also handles booleans -&gt; 1 or 0.</span>
    <span class="k">elif</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span>


<span class="c1"># AST.</span>


<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_coerce</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">method</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">clone</span>
        <span class="k">return</span> <span class="n">inner</span>

    <span class="k">def</span> <span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_coerce</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_coerce</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce</span><span class="p">:</span>
            <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">_coerce</span> <span class="o">=</span> <span class="n">_coerce</span>
            <span class="k">return</span> <span class="n">clone</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">unwrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">ColumnFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_DynamicColumn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ColumnFactory</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>  <span class="c1"># Implements __getattr__().</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">_ExplicitColumn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> specifies columns explicitly, and does not support &#39;</span>
                <span class="s1">&#39;dynamic column lookups.&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">_DynamicColumn</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">alias</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),)</span>
        <span class="k">return</span> <span class="n">Select</span><span class="p">((</span><span class="bp">self</span><span class="p">,),</span> <span class="n">columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="o">=</span><span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">left_outer_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cte</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">materialized</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CTE</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                   <span class="n">materialized</span><span class="o">=</span><span class="n">materialized</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">],)</span>

    <span class="k">def</span> <span class="nf">apply_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="c1"># If we are defining the source, include the &quot;AS alias&quot; declaration. An</span>
        <span class="c1"># alias is created for the source if one is not already defined.</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">apply_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]))</span>


<span class="k">class</span> <span class="nc">_HashableSource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_HashableSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_hash</span><span class="p">()</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_hash</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hash</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_HashableSource</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_hash</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_HashableSource</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_hash</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">NE</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_e</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="fm">__lt__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">LT</span><span class="p">)</span>
    <span class="fm">__le__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">LTE</span><span class="p">)</span>
    <span class="fm">__gt__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">GT</span><span class="p">)</span>
    <span class="fm">__ge__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">GTE</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__bind_database__</span><span class="p">(</span><span class="n">meth</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">inner</span>


<span class="k">def</span> <span class="nf">__join__</span><span class="p">(</span><span class="n">join_type</span><span class="o">=</span><span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">,</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">Join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">join_type</span><span class="o">=</span><span class="n">join_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">method</span>


<span class="k">class</span> <span class="nc">BaseTable</span><span class="p">(</span><span class="n">Source</span><span class="p">):</span>
    <span class="fm">__and__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">)</span>
    <span class="fm">__add__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
    <span class="fm">__sub__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">RIGHT_OUTER</span><span class="p">)</span>
    <span class="fm">__or__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">FULL_OUTER</span><span class="p">)</span>
    <span class="fm">__mul__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">CROSS</span><span class="p">)</span>
    <span class="fm">__rand__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__radd__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rsub__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">RIGHT_OUTER</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__ror__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">FULL_OUTER</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="n">__join__</span><span class="p">(</span><span class="n">JOIN</span><span class="o">.</span><span class="n">CROSS</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_BoundTableContext</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orig_database</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orig_database</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Table</span><span class="p">(</span><span class="n">_HashableSource</span><span class="p">,</span> <span class="n">BaseTable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key</span> <span class="o">=</span> <span class="n">primary_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">schema</span> <span class="k">else</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">_database</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Table</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>

        <span class="c1"># Allow tables to restrict what columns are available.</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">_ExplicitColumn</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">primary_key</span><span class="p">:</span>
            <span class="n">col_src</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">col_src</span><span class="p">,</span> <span class="n">primary_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure a deep copy of the column instances.</span>
        <span class="k">return</span> <span class="n">Table</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">,</span>
            <span class="n">primary_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span>
            <span class="n">alias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span>
            <span class="n">_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span>
            <span class="n">_database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">bind_ctx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_BoundTableContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">))</span>

    <span class="nd">@__bind_database__</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">Column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Select</span><span class="p">((</span><span class="bp">self</span><span class="p">,),</span> <span class="n">columns</span><span class="p">)</span>

    <span class="nd">@__bind_database__</span>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">insert</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">insert</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">insert</span>
            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">insert</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">Insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insert</span><span class="o">=</span><span class="n">insert</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

    <span class="nd">@__bind_database__</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span>
                <span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert</span><span class="o">=</span><span class="n">insert</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
                <span class="o">.</span><span class="n">on_conflict</span><span class="p">(</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">))</span>

    <span class="nd">@__bind_database__</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">update</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">update</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
                <span class="n">update</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">Update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span>

    <span class="nd">@__bind_database__</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_VALUES</span><span class="p">:</span>
            <span class="c1"># Return the quoted table name.</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>

        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span><span class="p">:</span>
            <span class="c1"># Define the table and its alias.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_alias</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Refer to the table using the alias.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_column</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Join</span><span class="p">(</span><span class="n">BaseTable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">join_type</span><span class="o">=</span><span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Join</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_type</span> <span class="o">=</span> <span class="n">join_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on</span> <span class="o">=</span> <span class="n">on</span>

    <span class="k">def</span> <span class="nf">on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on</span> <span class="o">=</span> <span class="n">predicate</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="p">(</span><span class="n">ctx</span>
         <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
         <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_type</span><span class="p">)</span>
         <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; ON &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">class</span> <span class="nc">ValuesList</span><span class="p">(</span><span class="n">_HashableSource</span><span class="p">,</span> <span class="n">BaseTable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ValuesList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">))</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">names</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>

        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span> <span class="ow">or</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_NORMAL</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">parentheses</span><span class="p">):</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span>
                       <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;VALUES &#39;</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">([</span>
                           <span class="n">EnclosedNodeList</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">])))</span>

            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">Entity</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">]</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">(</span><span class="n">entities</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">class</span> <span class="nc">CTE</span><span class="p">(</span><span class="n">_HashableSource</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">materialized</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recursive</span> <span class="o">=</span> <span class="n">recursive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_materialized</span> <span class="o">=</span> <span class="n">materialized</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">Entity</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span>
                       <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_cte_list</span> <span class="o">=</span> <span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CTE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;select_from() must specify one or more columns &#39;</span>
                             <span class="s1">&#39;from the CTE to select.&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Select</span><span class="p">((</span><span class="bp">self</span><span class="p">,),</span> <span class="n">columns</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">with_cte</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_database</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_get_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">union_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CTE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">clone</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recursive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>
    <span class="fm">__add__</span> <span class="o">=</span> <span class="n">union_all</span>

    <span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CTE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">clone</span> <span class="o">|</span> <span class="n">rhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recursive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>
    <span class="fm">__or__</span> <span class="o">=</span> <span class="n">union</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">!=</span> <span class="n">SCOPE_CTE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">push_alias</span><span class="p">():</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">))</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materialized</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;MATERIALIZED &#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_materialized</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;NOT MATERIALIZED &#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_normal</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">class</span> <span class="nc">ColumnBase</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="n">_converter</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_converter</span> <span class="o">=</span> <span class="n">converter</span>

    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">unalias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nulls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Asc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="n">collation</span><span class="p">,</span> <span class="n">nulls</span><span class="o">=</span><span class="n">nulls</span><span class="p">)</span>
    <span class="fm">__pos__</span> <span class="o">=</span> <span class="n">asc</span>

    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nulls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Desc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="n">collation</span><span class="p">,</span> <span class="n">nulls</span><span class="o">=</span><span class="n">nulls</span><span class="p">)</span>
    <span class="fm">__neg__</span> <span class="o">=</span> <span class="n">desc</span>

    <span class="k">def</span> <span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Negated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_e</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lightweight factory which returns a method that builds an Expression</span>
<span class="sd">        consisting of the left-hand and right-hand operands, using `op`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="fm">__and__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">AND</span><span class="p">)</span>
    <span class="fm">__or__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">OR</span><span class="p">)</span>

    <span class="fm">__add__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">ADD</span><span class="p">)</span>
    <span class="fm">__sub__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
    <span class="fm">__mul__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">MUL</span><span class="p">)</span>
    <span class="n">__div__</span> <span class="o">=</span> <span class="fm">__truediv__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">DIV</span><span class="p">)</span>
    <span class="fm">__xor__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">XOR</span><span class="p">)</span>
    <span class="fm">__radd__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rsub__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">SUB</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">MUL</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">__rdiv__</span> <span class="o">=</span> <span class="fm">__rtruediv__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">DIV</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rand__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">AND</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__ror__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">OR</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rxor__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">XOR</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS</span> <span class="k">if</span> <span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">OP</span><span class="o">.</span><span class="n">EQ</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS_NOT</span> <span class="k">if</span> <span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">OP</span><span class="o">.</span><span class="n">NE</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

    <span class="fm">__lt__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">LT</span><span class="p">)</span>
    <span class="fm">__le__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">LTE</span><span class="p">)</span>
    <span class="fm">__gt__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">GT</span><span class="p">)</span>
    <span class="fm">__ge__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">GTE</span><span class="p">)</span>
    <span class="fm">__lshift__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
    <span class="fm">__rshift__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">IS</span><span class="p">)</span>
    <span class="fm">__mod__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">LIKE</span><span class="p">)</span>
    <span class="fm">__pow__</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">)</span>

    <span class="n">bin_and</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">BIN_AND</span><span class="p">)</span>
    <span class="n">bin_or</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">BIN_OR</span><span class="p">)</span>
    <span class="n">in_</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
    <span class="n">not_in</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">NOT_IN</span><span class="p">)</span>
    <span class="n">regexp</span> <span class="o">=</span> <span class="n">_e</span><span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">REGEXP</span><span class="p">)</span>

    <span class="c1"># Special expressions.</span>
    <span class="k">def</span> <span class="nf">is_null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_null</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS</span> <span class="k">if</span> <span class="n">is_null</span> <span class="k">else</span> <span class="n">OP</span><span class="o">.</span><span class="n">IS_NOT</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_escape_like_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">NodeList</span><span class="p">((</span><span class="n">template</span> <span class="o">%</span> <span class="n">s</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ESCAPE&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="n">s</span>
    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span>
                             <span class="n">Expression</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_escape_like_expr</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%%%s%%</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">startswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_escape_like_expr</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s%%</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">endswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_escape_like_expr</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%%%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">ILIKE</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">BETWEEN</span><span class="p">,</span> <span class="n">NodeList</span><span class="p">((</span><span class="n">lo</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;AND&#39;</span><span class="p">),</span> <span class="n">hi</span><span class="p">)))</span>
    <span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">StringExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">REGEXP</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">iregexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">IREGEXP</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;BETWEEN range must have both a start- and &#39;</span>
                                 <span class="s1">&#39;end-point.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">item</span>

    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NodeList</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DISTINCT&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">collate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collation</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NodeList</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;COLLATE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">collation</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">get_sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">()</span>


<span class="k">class</span> <span class="nc">Column</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">get_sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_VALUES</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">get_sort_key</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_VALUES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_column</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">WrappedNode</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coerce</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;_coerce&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_converter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;_converter&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_alias</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">unwrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">EntityFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_DynamicEntity</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EntityFactory</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>  <span class="c1"># Implements __getattr__().</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">Alias</span><span class="p">(</span><span class="n">WrappedNode</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">_DynamicEntity</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Alias</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">alias</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unalias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span> <span class="nf">is_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ctx</span>
                    <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Negated</span><span class="p">(</span><span class="n">WrappedNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;NOT &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BitwiseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_and</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_or</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_and</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bin_negated</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BitwiseNegated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BitwiseNegated</span><span class="p">(</span><span class="n">BitwiseMixin</span><span class="p">,</span> <span class="n">WrappedNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="n">op_sql</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">operations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op_sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">op_sql</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Value</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">converter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span> <span class="o">=</span> <span class="n">unpack</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">multi_types</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Value</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="p">:</span>
            <span class="c1"># For multi-part values (e.g. lists of IDs).</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">AsIs</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Cast</span><span class="p">(</span><span class="n">WrappedNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">cast</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Cast</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span> <span class="o">=</span> <span class="n">cast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coerce</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ctx</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;CAST(&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; AS </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Ordering</span><span class="p">(</span><span class="n">WrappedNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nulls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Ordering</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collation</span> <span class="o">=</span> <span class="n">collation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nulls</span> <span class="o">=</span> <span class="n">nulls</span>
        <span class="k">if</span> <span class="n">nulls</span> <span class="ow">and</span> <span class="n">nulls</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Ordering nulls= parameter must be &quot;first&quot; or &#39;</span>
                             <span class="s1">&#39;&quot;last&quot;, got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nulls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">collate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Ordering</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">collation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_null_ordering_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nulls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nulls</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span>
            <span class="n">ifnull</span><span class="p">,</span> <span class="n">notnull</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">nulls</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;first&#39;</span><span class="p">:</span>
            <span class="n">ifnull</span><span class="p">,</span> <span class="n">notnull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unsupported value for nulls= ordering.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Case</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_null</span><span class="p">(),</span> <span class="n">ifnull</span><span class="p">),),</span> <span class="n">notnull</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nulls</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">nulls_ordering</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_null_ordering_case</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nulls</span><span class="p">))</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collation</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; COLLATE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">collation</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nulls</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">nulls_ordering</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; NULLS </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nulls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">def</span> <span class="nf">Asc</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nulls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Ordering</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;ASC&#39;</span><span class="p">,</span> <span class="n">collation</span><span class="p">,</span> <span class="n">nulls</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Desc</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nulls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Ordering</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">,</span> <span class="n">collation</span><span class="p">,</span> <span class="n">nulls</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Expression</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat</span> <span class="o">=</span> <span class="n">flat</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">overrides</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;parentheses&#39;</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="s1">&#39;in_expr&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

        <span class="c1"># First attempt to unwrap the node on the left-hand-side, so that we</span>
        <span class="c1"># can get at the underlying Field if one is present.</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">raw_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_node</span><span class="p">,</span> <span class="n">WrappedNode</span><span class="p">):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">raw_node</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>

        <span class="c1"># Set up the appropriate converter if we have a field on the left side.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="n">raw_node</span><span class="o">.</span><span class="n">_coerce</span><span class="p">:</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s1">&#39;converter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">db_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s1">&#39;converter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="n">op_sql</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">operations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op_sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="p">(</span><span class="o">**</span><span class="n">overrides</span><span class="p">):</span>
            <span class="c1"># Postgresql reports an error for IN/NOT IN (), so convert to</span>
            <span class="c1"># the equivalent boolean expression.</span>
            <span class="n">op_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="n">OP</span><span class="o">.</span><span class="n">IN</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="n">OP</span><span class="o">.</span><span class="n">NOT_IN</span>
            <span class="k">if</span> <span class="n">op_in</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">as_new</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;()&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;0 = 1&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="n">OP</span><span class="o">.</span><span class="n">IN</span> <span class="k">else</span> <span class="s1">&#39;1 = 1&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">ctx</span>
                    <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">op_sql</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">StringExpression</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">StringExpression</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Entity</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">if</span> <span class="n">part</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">+</span> <span class="p">[</span><span class="n">attr</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">quote</span> <span class="ow">or</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">SQL</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">add_param</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">def</span> <span class="nf">Check</span><span class="p">(</span><span class="n">constraint</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;CHECK (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">constraint</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">coerce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">python_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_value</span> <span class="o">=</span> <span class="n">python_value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;cast&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coerce</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coerce</span> <span class="o">=</span> <span class="n">coerce</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Function</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span> <span class="o">=</span> <span class="n">where</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ordering</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="n">ordering</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_value</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">over</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">frame_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_by</span><span class="p">,</span> <span class="n">Window</span><span class="p">)</span> <span class="ow">and</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">partition_by</span>

        <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">WindowAlias</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">partition_by</span><span class="o">=</span><span class="n">partition_by</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">order_by</span><span class="p">,</span>
                          <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">frame_type</span><span class="o">=</span><span class="n">frame_type</span><span class="p">,</span>
                          <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">_inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NodeList</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;OVER&#39;</span><span class="p">),</span> <span class="n">node</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>

            <span class="c1"># If this is an ordered aggregate, then we will modify the last</span>
            <span class="c1"># argument to append the ORDER BY ... clause. We do this to avoid</span>
            <span class="c1"># double-wrapping any expression args in parentheses, as NodeList</span>
            <span class="c1"># has a special check (hack) in place to work around this.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeList</span><span class="p">((</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ORDER BY&#39;</span><span class="p">),</span>
                                     <span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="p">)))</span>

            <span class="k">with</span> <span class="n">ctx</span><span class="p">(</span><span class="n">in_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">function_arg_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">)):</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">([</span>
                    <span class="p">(</span><span class="n">arg</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="k">else</span> <span class="n">Value</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; FILTER (WHERE &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">)</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="n">fn</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Window</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="c1"># Frame start/end and frame exclusion.</span>
    <span class="n">CURRENT_ROW</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;CURRENT ROW&#39;</span><span class="p">)</span>
    <span class="n">GROUP</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;GROUP&#39;</span><span class="p">)</span>
    <span class="n">TIES</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;TIES&#39;</span><span class="p">)</span>
    <span class="n">NO_OTHERS</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;NO OTHERS&#39;</span><span class="p">)</span>

    <span class="c1"># Frame types.</span>
    <span class="n">GROUPS</span> <span class="o">=</span> <span class="s1">&#39;GROUPS&#39;</span>
    <span class="n">RANGE</span> <span class="o">=</span> <span class="s1">&#39;RANGE&#39;</span>
    <span class="n">ROWS</span> <span class="o">=</span> <span class="s1">&#39;ROWS&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">frame_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extends</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">_inline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Window</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">SQL</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">SQL</span><span class="p">):</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">partition_by</span> <span class="o">=</span> <span class="n">ensure_tuple</span><span class="p">(</span><span class="n">partition_by</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">ensure_tuple</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify WINDOW end without start.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">alias</span> <span class="ow">or</span> <span class="s1">&#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inline</span> <span class="o">=</span> <span class="n">_inline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_type</span> <span class="o">=</span> <span class="n">frame_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extends</span> <span class="o">=</span> <span class="n">extends</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclude</span> <span class="o">=</span> <span class="n">exclude</span>

    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">alias</span> <span class="ow">or</span> <span class="s1">&#39;w&#39;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">as_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_type</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">RANGE</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">as_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_type</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">ROWS</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">as_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_type</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">GROUPS</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">extends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extends</span> <span class="o">=</span> <span class="n">window</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_exclusion</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame_exclusion</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">frame_exclusion</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">frame_exclusion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclude</span> <span class="o">=</span> <span class="n">frame_exclusion</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">following</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;UNBOUNDED FOLLOWING&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> FOLLOWING&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">preceding</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;UNBOUNDED PRECEDING&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> PRECEDING&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">!=</span> <span class="n">SCOPE_SOURCE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inline</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extends</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extends</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">Window</span><span class="p">):</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_by</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;PARTITION BY&#39;</span><span class="p">),</span>
                    <span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_by</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ORDER BY&#39;</span><span class="p">),</span>
                    <span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_type</span> <span class="ow">or</span> <span class="s1">&#39;ROWS&#39;</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> BETWEEN&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;AND&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_type</span> <span class="ow">or</span> <span class="s1">&#39;ROWS&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> UNBOUNDED PRECEDING&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;EXCLUDE&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclude</span><span class="p">))</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">NodeList</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">class</span> <span class="nc">WindowAlias</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>

    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_alias</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">window_alias</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">or</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ForUpdate</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;FOR UPDATE&#39;</span> <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">expr</span>
        <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nowait&#39;</span><span class="p">):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span>  <span class="c1"># Strip off the &quot;nowait&quot; bit.</span>
            <span class="n">nowait</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_expr</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="k">if</span> <span class="n">of</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">of</span> <span class="o">=</span> <span class="p">(</span><span class="n">of</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_of</span> <span class="o">=</span> <span class="n">of</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nowait</span> <span class="o">=</span> <span class="n">nowait</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_of</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; OF &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_of</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nowait</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; NOWAIT&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">def</span> <span class="nf">Case</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">expression_tuples</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;CASE&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">predicate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">expression_tuples</span><span class="p">:</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;WHEN&#39;</span><span class="p">),</span> <span class="n">expr</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;THEN&#39;</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ELSE&#39;</span><span class="p">),</span> <span class="n">default</span><span class="p">))</span>
    <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;END&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">NodeList</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NodeList</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">glue</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">parens</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glue</span> <span class="o">=</span> <span class="n">glue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="o">=</span> <span class="n">parens</span>
        <span class="k">if</span> <span class="n">parens</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> \
           <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Expression</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="c1"># Hack to avoid double-parentheses.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flat</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">n_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="k">else</span> <span class="n">ctx</span>
        <span class="k">with</span> <span class="n">ctx</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glue</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">def</span> <span class="nf">CommaNodeList</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NodeList</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">EnclosedNodeList</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NodeList</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Namespace</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_name&#39;</span><span class="p">,)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NamespaceAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="fm">__getitem__</span> <span class="o">=</span> <span class="fm">__getattr__</span>

<span class="k">class</span> <span class="nc">NamespaceAttribute</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attribute</span> <span class="o">=</span> <span class="n">attribute</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ctx</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attribute</span><span class="p">)))</span>

<span class="n">EXCLUDED</span> <span class="o">=</span> <span class="n">_Namespace</span><span class="p">(</span><span class="s1">&#39;EXCLUDED&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DQ</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DQ</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negated</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negated</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negated</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">DQ</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">_negated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negated</span>
        <span class="k">return</span> <span class="n">node</span>

<span class="c1">#: Represent a row tuple.</span>
<span class="n">Tuple</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">:</span> <span class="n">EnclosedNodeList</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">QualifiedNames</span><span class="p">(</span><span class="n">WrappedNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_column</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">qualify_names</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="c1"># Search a node heirarchy to ensure that any column-like objects are</span>
    <span class="c1"># referenced using fully-qualified names.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">qualify_names</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lhs</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span>
                              <span class="n">qualify_names</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rhs</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ColumnBase</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QualifiedNames</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span>


<span class="k">class</span> <span class="nc">OnConflict</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conflict_target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conflict_where</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conflict_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preserve</span> <span class="o">=</span> <span class="n">ensure_tuple</span><span class="p">(</span><span class="n">preserve</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="n">where</span>
        <span class="k">if</span> <span class="n">conflict_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">conflict_constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;only one of &quot;conflict_target&quot; and &#39;</span>
                             <span class="s1">&#39;&quot;conflict_constraint&quot; may be specified.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_target</span> <span class="o">=</span> <span class="n">ensure_tuple</span><span class="p">(</span><span class="n">conflict_target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_where</span> <span class="o">=</span> <span class="n">conflict_where</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_constraint</span> <span class="o">=</span> <span class="n">conflict_constraint</span>

    <span class="k">def</span> <span class="nf">get_conflict_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">conflict_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_conflict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">conflict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">preserve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preserve</span> <span class="o">=</span> <span class="n">columns</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_data</span> <span class="ow">and</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot mix data with keyword arguments in the &#39;</span>
                             <span class="s1">&#39;OnConflict update method.&#39;</span><span class="p">)</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="n">_data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">_data</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">,)</span> <span class="o">+</span> <span class="n">expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">conflict_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">constraints</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_constraint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_target</span> <span class="o">=</span> <span class="n">constraints</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">conflict_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conflict_where</span><span class="p">,)</span> <span class="o">+</span> <span class="n">expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_where</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">conflict_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_constraint</span> <span class="o">=</span> <span class="n">constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflict_target</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">database_required</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">database</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">database</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s1">&#39;Query must be bound to a database in order &#39;</span>
                                 <span class="s1">&#39;to call &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inner</span>

<span class="c1"># BASE QUERY INTERFACE.</span>

<span class="k">class</span> <span class="nc">BaseQuery</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="n">default_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">DICT</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">_database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BaseQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">DICT</span> <span class="k">if</span> <span class="n">as_dict</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">TUPLE</span> <span class="k">if</span> <span class="n">as_tuple</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">namedtuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_namedtuple</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">NAMED_TUPLE</span> <span class="k">if</span> <span class="n">as_namedtuple</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constructor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">CONSTRUCTOR</span> <span class="k">if</span> <span class="n">constructor</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span> <span class="o">=</span> <span class="n">constructor</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_get_cursor_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="n">row_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_row_type</span>

        <span class="k">if</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">DICT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DictCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">TUPLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">NAMED_TUPLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NamedTupleCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">CONSTRUCTOR</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ObjectCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized row type: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">row_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">get_sql_context</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@database_required</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">iterator</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_ensure_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Query has not been executed.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_execution</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_execution</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span><span class="o">.</span><span class="n">fill_cache</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span><span class="o">.</span><span class="n">row_cache</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_execution</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RawQuery</span><span class="p">(</span><span class="n">BaseQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RawQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="n">sql</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">add_param</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cursor_wrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span>


<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="n">BaseQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="n">where</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="n">order_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cte_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">with_cte</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">cte_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cte_list</span> <span class="o">=</span> <span class="n">cte_list</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">,)</span> <span class="o">+</span> <span class="n">expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">orwhere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">,)</span> <span class="o">+</span> <span class="n">expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="n">values</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">order_by_extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span> <span class="ow">or</span> <span class="p">())</span> <span class="o">+</span> <span class="n">values</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">paginate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">paginate_by</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">paginate_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">paginate_by</span>

    <span class="k">def</span> <span class="nf">_apply_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ctx</span>
             <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; ORDER BY &#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_by</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                                       <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">limit_max</span><span class="p">):</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">limit_max</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; LIMIT &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; OFFSET &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cte_list</span><span class="p">:</span>
            <span class="c1"># The CTE scope is only used at the very beginning of the query,</span>
            <span class="c1"># when we are describing the various CTEs we will be using.</span>
            <span class="n">recursive</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">cte</span><span class="o">.</span><span class="n">_recursive</span> <span class="k">for</span> <span class="n">cte</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cte_list</span><span class="p">)</span>

            <span class="c1"># Explicitly disable the &quot;subquery&quot; flag here, so as to avoid</span>
            <span class="c1"># unnecessary parentheses around subsequent selects.</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_cte</span><span class="p">(</span><span class="n">subquery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="p">(</span><span class="n">ctx</span>
                 <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;WITH RECURSIVE &#39;</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="s1">&#39;WITH &#39;</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cte_list</span><span class="p">))</span>
                 <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">def</span> <span class="nf">__compound_select__</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">,</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">CompoundSelectQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">method</span>


<span class="k">class</span> <span class="nc">SelectQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
    <span class="n">union_all</span> <span class="o">=</span> <span class="fm">__add__</span> <span class="o">=</span> <span class="n">__compound_select__</span><span class="p">(</span><span class="s1">&#39;UNION ALL&#39;</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="fm">__or__</span> <span class="o">=</span> <span class="n">__compound_select__</span><span class="p">(</span><span class="s1">&#39;UNION&#39;</span><span class="p">)</span>
    <span class="n">intersect</span> <span class="o">=</span> <span class="fm">__and__</span> <span class="o">=</span> <span class="n">__compound_select__</span><span class="p">(</span><span class="s1">&#39;INTERSECT&#39;</span><span class="p">)</span>
    <span class="n">except_</span> <span class="o">=</span> <span class="fm">__sub__</span> <span class="o">=</span> <span class="n">__compound_select__</span><span class="p">(</span><span class="s1">&#39;EXCEPT&#39;</span><span class="p">)</span>
    <span class="fm">__radd__</span> <span class="o">=</span> <span class="n">__compound_select__</span><span class="p">(</span><span class="s1">&#39;UNION ALL&#39;</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__ror__</span> <span class="o">=</span> <span class="n">__compound_select__</span><span class="p">(</span><span class="s1">&#39;UNION&#39;</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rand__</span> <span class="o">=</span> <span class="n">__compound_select__</span><span class="p">(</span><span class="s1">&#39;INTERSECT&#39;</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="fm">__rsub__</span> <span class="o">=</span> <span class="n">__compound_select__</span><span class="p">(</span><span class="s1">&#39;EXCEPT&#39;</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;select_from() must specify one or more columns.&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Select</span><span class="p">((</span><span class="bp">self</span><span class="p">,),</span> <span class="n">columns</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Bind to the sub-select&#39;s model type, if defined.</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>


<span class="k">class</span> <span class="nc">SelectBase</span><span class="p">(</span><span class="n">_HashableSource</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">SelectQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_get_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">or</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cursor_wrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span>

    <span class="nd">@database_required</span>
    <span class="k">def</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">database</span><span class="p">)[:</span><span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">rows</span>

    <span class="nd">@database_required</span>
    <span class="k">def</span> <span class="nf">first</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

    <span class="nd">@database_required</span>
    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuples</span><span class="p">()</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">as_tuple</span> <span class="k">else</span> <span class="n">row</span>

    <span class="nd">@database_required</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">clear_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;_wrapped&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clear_limit</span><span class="p">:</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clone</span><span class="o">.</span><span class="n">_having</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clone</span><span class="o">.</span><span class="n">_group_by</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> \
               <span class="n">clone</span><span class="o">.</span><span class="n">_windows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clone</span><span class="o">.</span><span class="n">_distinct</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> \
               <span class="n">clone</span><span class="o">.</span><span class="n">_simple_distinct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">clone</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">Select</span><span class="p">([</span><span class="n">clone</span><span class="p">],</span> <span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">))])</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

    <span class="nd">@database_required</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">))</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">scalar</span><span class="p">())</span>

    <span class="nd">@database_required</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">database</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="c1"># QUERY IMPLEMENTATIONS.</span>


<span class="k">class</span> <span class="nc">CompoundSelectQuery</span><span class="p">(</span><span class="n">SelectBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CompoundSelectQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_returning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">_returning</span>

    <span class="nd">@database_required</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Select</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">),),</span> <span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">),))</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">scalar</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_get_query_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">get_query_key</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">get_query_key</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_wrap_parens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">subq</span><span class="p">):</span>
        <span class="n">csq_setting</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compound_select_parentheses</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">csq_setting</span> <span class="ow">or</span> <span class="n">csq_setting</span> <span class="o">==</span> <span class="n">CSQ_PARENTHESES_NEVER</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">csq_setting</span> <span class="o">==</span> <span class="n">CSQ_PARENTHESES_ALWAYS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">csq_setting</span> <span class="o">==</span> <span class="n">CSQ_PARENTHESES_UNNESTED</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">in_expr</span> <span class="ow">or</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">in_function</span><span class="p">:</span>
                <span class="c1"># If this compound select query is being used inside an</span>
                <span class="c1"># expression, e.g., an IN or EXISTS().</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># If the query on the left or right is itself a compound select</span>
            <span class="c1"># query, then we do not apply parentheses. However, if it is a</span>
            <span class="c1"># regular SELECT query, we will apply parentheses.</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subq</span><span class="p">,</span> <span class="n">CompoundSelectQuery</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_COLUMN</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_column</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

        <span class="c1"># Call parent method to handle any CTEs.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CompoundSelectQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__sql__</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

        <span class="n">outer_parens</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">subquery</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ctx</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="n">outer_parens</span><span class="p">):</span>
            <span class="c1"># Should the left-hand query be wrapped in parentheses?</span>
            <span class="n">lhs_parens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_parens</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_normal</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="n">lhs_parens</span><span class="p">,</span> <span class="n">subquery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">push_alias</span><span class="p">():</span>
                <span class="c1"># Should the right-hand query be wrapped in parentheses?</span>
                <span class="n">rhs_parens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_parens</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_normal</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="n">rhs_parens</span><span class="p">,</span> <span class="n">subquery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>

            <span class="c1"># Apply ORDER BY, LIMIT, OFFSET. We use the &quot;values&quot; scope so that</span>
            <span class="c1"># entity names are not fully-qualified. This is a bit of a hack, as</span>
            <span class="c1"># we&#39;re relying on the logic in Column.__sql__() to not fully</span>
            <span class="c1"># qualify column names.</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ordering</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_alias</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Select</span><span class="p">(</span><span class="n">SelectBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">having</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">for_update_of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lateral</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Select</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">from_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
                           <span class="k">else</span> <span class="n">from_list</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span> <span class="o">=</span> <span class="n">group_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_having</span> <span class="o">=</span> <span class="n">having</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_windows</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update</span> <span class="o">=</span> <span class="n">for_update</span>  <span class="c1"># XXX: consider reorganizing.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update_of</span> <span class="o">=</span> <span class="n">for_update_of</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update_nowait</span> <span class="o">=</span> <span class="n">nowait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lateral</span> <span class="o">=</span> <span class="n">lateral</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_distinct</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">distinct</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distinct</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simple_distinct</span> <span class="o">=</span> <span class="n">distinct</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="n">distinct</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Select</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clone</span><span class="o">.</span><span class="n">_from_list</span><span class="p">:</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">_from_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">_from_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clone</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="n">select</span> <span class="o">=</span> <span class="n">columns</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">select_extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span> <span class="o">+</span> <span class="n">columns</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">from_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sources</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="o">=</span><span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No sources to join on.&#39;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Join</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="p">,</span> <span class="n">on</span><span class="p">))</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">grouping</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">column</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot pass a table to group_by() that &#39;</span>
                                     <span class="s1">&#39;does not have columns explicitly &#39;</span>
                                     <span class="s1">&#39;declared.&#39;</span><span class="p">)</span>
                <span class="n">grouping</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">col_name</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">_columns</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span> <span class="o">=</span> <span class="n">grouping</span>

    <span class="k">def</span> <span class="nf">group_by_extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;@Node.copy used from group_by() call&quot;&quot;&quot;</span>
        <span class="n">group_by</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span> <span class="ow">or</span> <span class="p">())</span> <span class="o">+</span> <span class="n">values</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">*</span><span class="n">group_by</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">having</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_having</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_having</span><span class="p">,)</span> <span class="o">+</span> <span class="n">expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_having</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simple_distinct</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simple_distinct</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="n">columns</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">windows</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_windows</span> <span class="o">=</span> <span class="n">windows</span> <span class="k">if</span> <span class="n">windows</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">for_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">for_update</span> <span class="ow">and</span> <span class="p">(</span><span class="n">of</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nowait</span><span class="p">):</span>
            <span class="n">for_update</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update</span> <span class="o">=</span> <span class="n">for_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update_of</span> <span class="o">=</span> <span class="n">of</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_for_update_nowait</span> <span class="o">=</span> <span class="n">nowait</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">lateral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lateral</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lateral</span> <span class="o">=</span> <span class="n">lateral</span>

    <span class="k">def</span> <span class="nf">_get_query_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>

    <span class="k">def</span> <span class="nf">__sql_selection__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">is_subquery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_COLUMN</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_column</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lateral</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;LATERAL &#39;</span><span class="p">)</span>

        <span class="n">is_subquery</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">subquery</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;converter&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;in_function&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;parentheses&#39;</span><span class="p">:</span> <span class="n">is_subquery</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span><span class="p">),</span>
            <span class="s1">&#39;subquery&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">in_function</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">function_arg_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;parentheses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_normal</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">):</span>
            <span class="c1"># Defer calling parent SQL until here. This ensures that any CTEs</span>
            <span class="c1"># for this query will be properly nested if this query is a</span>
            <span class="c1"># sub-select or is used in an expression. See GH#1809 for example.</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Select</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__sql__</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;SELECT &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_distinct</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;DISTINCT &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">ctx</span>
                     <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;ON &#39;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span><span class="p">))</span>
                     <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>

            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_source</span><span class="p">():</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sql_selection__</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">is_subquery</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_source</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; FROM &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; WHERE &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; GROUP BY &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_having</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; HAVING &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_having</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_windows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; WINDOW &#39;</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_windows</span><span class="p">))</span>

            <span class="c1"># Apply ORDER BY, LIMIT, OFFSET.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ordering</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_for_update</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;FOR UPDATE specified but not supported &#39;</span>
                                     <span class="s1">&#39;by database.&#39;</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">ForUpdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_for_update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_for_update_of</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_for_update_nowait</span><span class="p">))</span>

        <span class="c1"># If the subquery is inside a function -or- we are evaluating a</span>
        <span class="c1"># subquery on either side of an expression w/o an explicit alias, do</span>
        <span class="c1"># not generate an alias + AS clause.</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">in_function</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">in_expr</span> <span class="ow">and</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ctx</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_alias</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_WriteQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">returning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="n">returning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_cursor</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">returning</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">returning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">returning</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="n">returning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_cursor</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">returning</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">apply_returning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_source</span><span class="p">():</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; RETURNING &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_returning</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_result</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_returning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cursor_wrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span>

    <span class="k">def</span> <span class="nf">handle_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_cursor</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cursor</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">rows_affected</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_table_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__sql__</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="c1"># We explicitly set the table alias to the table&#39;s name, which ensures</span>
        <span class="c1"># that if a sub-select references a column on the outer table, we won&#39;t</span>
        <span class="c1"># assign it a new alias (e.g. t2) but will refer to it as table.column.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_table_alias</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">class</span> <span class="nc">Update</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Update</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">from_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sources</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from</span> <span class="o">=</span> <span class="n">sources</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Update</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__sql__</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_values</span><span class="p">(</span><span class="n">subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;UPDATE &#39;</span><span class="p">)</span>

            <span class="n">expressions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">column_sort_key</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">qualify_names</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NodeList</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span>

            <span class="p">(</span><span class="n">ctx</span>
             <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
             <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; SET &#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="n">expressions</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_source</span><span class="p">(</span><span class="n">parentheses</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; FROM &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_normal</span><span class="p">():</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; WHERE &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ordering</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_returning</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Insert</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">):</span>
    <span class="n">SIMPLE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">QUERY</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">MULTI</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">class</span> <span class="nc">DefaultValuesException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">insert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_conflict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Insert</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span> <span class="o">=</span> <span class="n">insert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="n">on_conflict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;INSERT queries cannot have a WHERE clause.&#39;</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">on_conflict_ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="n">OnConflict</span><span class="p">(</span><span class="s1">&#39;IGNORE&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ignore</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">on_conflict_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="n">OnConflict</span><span class="p">(</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">replace</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">on_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="o">=</span> <span class="p">(</span><span class="n">OnConflict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">)</span>
                             <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_simple_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">DefaultValuesException</span><span class="p">(</span><span class="s1">&#39;Error: no data to insert.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_insert</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">,),</span> <span class="n">ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_default_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_default_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_columns</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_generate_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">rows_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">insert</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span>

        <span class="c1"># Load and organize column defaults (if provided).</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_data</span><span class="p">()</span>

        <span class="c1"># First figure out what columns are being inserted (if they weren&#39;t</span>
        <span class="c1"># specified explicitly). Resulting columns are normalized and ordered.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">rows_iter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">DefaultValuesException</span><span class="p">(</span><span class="s1">&#39;Error: no rows to insert.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_columns</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bulk insert must specify columns.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Infer column names from the dict of data being inserted.</span>
                <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                        <span class="n">column</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                    <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

                <span class="c1"># Add any columns present in the default data that are not</span>
                <span class="c1"># accounted for by the dictionary of row data.</span>
                <span class="n">column_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">accum</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span> <span class="o">-</span> <span class="n">column_set</span><span class="p">):</span>
                    <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

                <span class="n">columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_sort_key</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
            <span class="n">rows_iter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="nb">iter</span><span class="p">((</span><span class="n">row</span><span class="p">,)),</span> <span class="n">rows_iter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clean_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">column_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">column_obj</span> <span class="o">=</span> <span class="n">column</span>
                <span class="n">clean_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_obj</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">column_obj</span><span class="p">)</span>

            <span class="n">columns</span> <span class="o">=</span> <span class="n">clean_columns</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_sort_key</span><span class="p">(</span><span class="n">ctx</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="n">value_lookups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">lookups</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">column</span><span class="o">.</span><span class="n">column_name</span><span class="p">:</span>
                <span class="n">lookups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">column_name</span><span class="p">)</span>
            <span class="n">value_lookups</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookups</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; VALUES &#39;</span><span class="p">)</span>
        <span class="n">columns_converters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">db_value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>

        <span class="n">all_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_iter</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">is_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_converters</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_dict</span><span class="p">:</span>
                        <span class="c1"># The logic is a bit convoluted, but in order to be</span>
                        <span class="c1"># flexible in what we accept (dict keyed by</span>
                        <span class="c1"># column/field, field name, or underlying column name),</span>
                        <span class="c1"># we try accessing the row data dict using each</span>
                        <span class="c1"># possible key. If no match is found, throw an error.</span>
                        <span class="k">for</span> <span class="n">lookup</span> <span class="ow">in</span> <span class="n">value_lookups</span><span class="p">[</span><span class="n">column</span><span class="p">]:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">lookup</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">KeyError</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">callable_</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Missing value for </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="n">converter</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="n">all_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">DefaultValuesException</span><span class="p">(</span><span class="s1">&#39;Error: no data to insert.&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_values</span><span class="p">(</span><span class="n">subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="n">all_values</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_query_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ctx</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">))</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_default_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;DEFAULT VALUES&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">default_values_insert</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Insert</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__sql__</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_values</span><span class="p">():</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span><span class="o">.</span><span class="n">get_conflict_statement</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="p">(</span><span class="n">ctx</span>
             <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">stmt</span> <span class="ow">or</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;INSERT&#39;</span><span class="p">))</span>
             <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; INTO &#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
             <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simple_insert</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">DefaultValuesException</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_default_values</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_query_type</span> <span class="o">=</span> <span class="n">Insert</span><span class="o">.</span><span class="n">SIMPLE</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">,</span> <span class="p">(</span><span class="n">SelectQuery</span><span class="p">,</span> <span class="n">SQL</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_query_insert</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_query_type</span> <span class="o">=</span> <span class="n">Insert</span><span class="o">.</span><span class="n">QUERY</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_query_type</span> <span class="o">=</span> <span class="n">Insert</span><span class="o">.</span><span class="n">MULTI</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict</span><span class="o">.</span><span class="n">get_conflict_update</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_returning</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">database</span><span class="o">.</span><span class="n">returning_clause</span> \
           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">,)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Insert</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">DefaultValuesException</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_cursor</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cursor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_type</span> <span class="o">!=</span> <span class="n">Insert</span><span class="o">.</span><span class="n">SIMPLE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">rows_affected</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">last_insert_id</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_type</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Delete</span><span class="p">(</span><span class="n">_WriteQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Delete</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__sql__</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_values</span><span class="p">(</span><span class="n">subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;DELETE FROM &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_normal</span><span class="p">():</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; WHERE &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ordering</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_returning</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span> <span class="k">else</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expressions</span> <span class="o">=</span> <span class="n">expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="n">where</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique</span> <span class="o">=</span> <span class="n">unique</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe</span> <span class="o">=</span> <span class="n">safe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_using</span> <span class="o">=</span> <span class="n">using</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">safe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_safe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe</span> <span class="o">=</span> <span class="n">_safe</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">,)</span> <span class="o">+</span> <span class="n">expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">using</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_using</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_using</span> <span class="o">=</span> <span class="n">_using</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;CREATE UNIQUE INDEX &#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique</span> <span class="k">else</span> <span class="s1">&#39;CREATE INDEX &#39;</span>
        <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope_values</span><span class="p">(</span><span class="n">subquery</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;IF NOT EXISTS &#39;</span><span class="p">)</span>

            <span class="c1"># Sqlite uses CREATE INDEX &lt;schema&gt;.&lt;name&gt; ON &lt;table&gt;, whereas most</span>
            <span class="c1"># others use: CREATE INDEX &lt;name&gt; ON &lt;schema&gt;.&lt;table&gt;.</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">index_schema_prefix</span> <span class="ow">and</span> \
               <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_schema</span><span class="p">:</span>
                <span class="n">index_name</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_name</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>

            <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">index_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
               <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">index_using_precedes_table</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; USING </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using</span><span class="p">)</span>  <span class="c1"># MySQL style.</span>

            <span class="p">(</span><span class="n">ctx</span>
             <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; ON &#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
             <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> \
               <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">index_using_precedes_table</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;USING </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using</span><span class="p">)</span>  <span class="c1"># Postgres/default.</span>

            <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">([</span>
                <span class="n">SQL</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="n">expr</span>
                <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expressions</span><span class="p">]))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; WHERE &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">class</span> <span class="nc">ModelIndex</span><span class="p">(</span><span class="n">Index</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_name_from_fields</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">using</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;index_type&#39;</span><span class="p">):</span>
                    <span class="n">using</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">index_type</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelIndex</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
            <span class="n">expressions</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">,</span>
            <span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span>
            <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
            <span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_name_from_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                    <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">accum</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to generate a name for the index, please &#39;</span>
                             <span class="s1">&#39;explicitly specify a name.&#39;</span><span class="p">)</span>

        <span class="n">clean_field_names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accum</span><span class="p">))</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">legacy_table_names</span> <span class="k">else</span> <span class="n">meta</span><span class="o">.</span><span class="n">table_name</span>
        <span class="k">return</span> <span class="n">_truncate_constraint_name</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">prefix</span><span class="p">,</span> <span class="n">clean_field_names</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_truncate_constraint_name</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">:</span>
        <span class="n">name_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">constraint</span><span class="p">[:(</span><span class="n">maxlen</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)],</span> <span class="n">name_hash</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">constraint</span>


<span class="c1"># DB-API 2.0 EXCEPTIONS.</span>


<span class="k">class</span> <span class="nc">PeeweeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orig</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PeeweeException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ImproperlyConfigured</span><span class="p">(</span><span class="n">PeeweeException</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">DatabaseError</span><span class="p">(</span><span class="n">PeeweeException</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">DataError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">IntegrityError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">InterfaceError</span><span class="p">(</span><span class="n">PeeweeException</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">InternalError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">NotSupportedError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">OperationalError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ProgrammingError</span><span class="p">(</span><span class="n">DatabaseError</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ExceptionWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># psycopg2.8 shits out a million cute error types. Try to catch em all.</span>
        <span class="k">if</span> <span class="n">pg_errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exc_type</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> \
           <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">pg_errors</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
            <span class="n">exc_type</span> <span class="o">=</span> <span class="n">exc_type</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exc_type</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
            <span class="n">new_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="n">exc_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
            <span class="n">exc_args</span> <span class="o">=</span> <span class="n">exc_value</span><span class="o">.</span><span class="n">args</span>
            <span class="n">reraise</span><span class="p">(</span><span class="n">new_type</span><span class="p">,</span> <span class="n">new_type</span><span class="p">(</span><span class="n">exc_value</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_args</span><span class="p">),</span> <span class="n">traceback</span><span class="p">)</span>


<span class="n">EXCEPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ConstraintError&#39;</span><span class="p">:</span> <span class="n">IntegrityError</span><span class="p">,</span>
    <span class="s1">&#39;DatabaseError&#39;</span><span class="p">:</span> <span class="n">DatabaseError</span><span class="p">,</span>
    <span class="s1">&#39;DataError&#39;</span><span class="p">:</span> <span class="n">DataError</span><span class="p">,</span>
    <span class="s1">&#39;IntegrityError&#39;</span><span class="p">:</span> <span class="n">IntegrityError</span><span class="p">,</span>
    <span class="s1">&#39;InterfaceError&#39;</span><span class="p">:</span> <span class="n">InterfaceError</span><span class="p">,</span>
    <span class="s1">&#39;InternalError&#39;</span><span class="p">:</span> <span class="n">InternalError</span><span class="p">,</span>
    <span class="s1">&#39;NotSupportedError&#39;</span><span class="p">:</span> <span class="n">NotSupportedError</span><span class="p">,</span>
    <span class="s1">&#39;OperationalError&#39;</span><span class="p">:</span> <span class="n">OperationalError</span><span class="p">,</span>
    <span class="s1">&#39;ProgrammingError&#39;</span><span class="p">:</span> <span class="n">ProgrammingError</span><span class="p">,</span>
    <span class="s1">&#39;TransactionRollbackError&#39;</span><span class="p">:</span> <span class="n">OperationalError</span><span class="p">}</span>

<span class="n">__exception_wrapper__</span> <span class="o">=</span> <span class="n">ExceptionWrapper</span><span class="p">(</span><span class="n">EXCEPTIONS</span><span class="p">)</span>


<span class="c1"># DATABASE INTERFACE AND CONNECTION MANAGEMENT.</span>


<span class="n">IndexMetadata</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;IndexMetadata&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="s1">&#39;unique&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">))</span>
<span class="n">ColumnMetadata</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;ColumnMetadata&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;data_type&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;primary_key&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">))</span>
<span class="n">ForeignKeyMetadata</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;ForeignKeyMetadata&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="s1">&#39;dest_table&#39;</span><span class="p">,</span> <span class="s1">&#39;dest_column&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">))</span>
<span class="n">ViewMetadata</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ViewMetadata&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_ConnectionState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_ConnectionState</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">class</span> <span class="nc">_ConnectionLocal</span><span class="p">(</span><span class="n">_ConnectionState</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">_NoopLock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ConnectionContext</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Database</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="n">context_class</span> <span class="o">=</span> <span class="n">Context</span>
    <span class="n">field_types</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">operations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">param</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
    <span class="n">server_version</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Feature toggles.</span>
    <span class="n">commit_select</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">compound_select_parentheses</span> <span class="o">=</span> <span class="n">CSQ_PARENTHESES_NEVER</span>
    <span class="n">for_update</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">index_schema_prefix</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">index_using_precedes_table</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">limit_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nulls_ordering</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">returning_clause</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">safe_create_index</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">safe_drop_index</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">truncate_table</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">thread_safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autorollback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">field_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">autoconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_types</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="n">FIELD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_operations</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_field_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field_types</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_operations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autoconnect</span> <span class="o">=</span> <span class="n">autoconnect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autorollback</span> <span class="o">=</span> <span class="n">autorollback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe</span> <span class="o">=</span> <span class="n">thread_safe</span>
        <span class="k">if</span> <span class="n">thread_safe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_ConnectionLocal</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_ConnectionState</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">_NoopLock</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">autocommit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">__deprecated__</span><span class="p">(</span><span class="s1">&#39;Peewee no longer uses the &quot;autocommit&quot; option, as &#39;</span>
                           <span class="s1">&#39;the semantics now require it to always be True. &#39;</span>
                           <span class="s1">&#39;Because some database-drivers also use the &#39;</span>
                           <span class="s1">&#39;&quot;autocommit&quot; parameter, you are receiving a &#39;</span>
                           <span class="s1">&#39;warning so you may update your code and remove &#39;</span>
                           <span class="s1">&#39;the parameter, as in the future, specifying &#39;</span>
                           <span class="s1">&#39;autocommit could impact the behavior of the &#39;</span>
                           <span class="s1">&#39;database driver you are using.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connect_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">ctx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connection_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reuse_if_open</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s1">&#39;Error, database must be initialized &#39;</span>
                                     <span class="s1">&#39;before opening a connection.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reuse_if_open</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s1">&#39;Connection already opened.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">__exception_wrapper__</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">set_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_server_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_initialize_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_set_server_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s1">&#39;Error, database must be initialized &#39;</span>
                                     <span class="s1">&#39;before opening a connection.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s1">&#39;Attempting to close database while &#39;</span>
                                       <span class="s1">&#39;transaction is open.&#39;</span><span class="p">)</span>
            <span class="n">is_open</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">closed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_open</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">__exception_wrapper__</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">is_open</span>

    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">closed</span>

    <span class="k">def</span> <span class="nf">is_connection_usable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">closed</span>

    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">conn</span>

    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoconnect</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s1">&#39;Error, database connection not opened.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">SENTINEL</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">commit</span> <span class="ow">is</span> <span class="n">SENTINEL</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
                <span class="n">commit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_select</span><span class="p">:</span>
                <span class="n">commit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commit</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">sql</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">__exception_wrapper__</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autorollback</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">commit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cursor</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">SENTINEL</span><span class="p">,</span> <span class="o">**</span><span class="n">context_options</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sql_context</span><span class="p">(</span><span class="o">**</span><span class="n">context_options</span><span class="p">)</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_context_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;field_types&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_types</span><span class="p">,</span>
            <span class="s1">&#39;operations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_operations</span><span class="p">,</span>
            <span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
            <span class="s1">&#39;quote&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">,</span>
            <span class="s1">&#39;compound_select_parentheses&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound_select_parentheses</span><span class="p">,</span>
            <span class="s1">&#39;conflict_statement&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conflict_statement</span><span class="p">,</span>
            <span class="s1">&#39;conflict_update&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conflict_update</span><span class="p">,</span>
            <span class="s1">&#39;for_update&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">,</span>
            <span class="s1">&#39;index_schema_prefix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_schema_prefix</span><span class="p">,</span>
            <span class="s1">&#39;index_using_precedes_table&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_using_precedes_table</span><span class="p">,</span>
            <span class="s1">&#39;limit_max&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_max</span><span class="p">,</span>
            <span class="s1">&#39;nulls_ordering&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nulls_ordering</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_sql_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">context_options</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_options</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">context_options</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">context_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_class</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">conflict_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">conflict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_build_on_conflict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_conflict_target</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON CONFLICT&#39;</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">EnclosedNodeList</span><span class="p">([</span>
                <span class="n">Entity</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="n">col</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_conflict_target</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_conflict_where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">NodeList</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;WHERE&#39;</span><span class="p">),</span>
                                   <span class="n">on_conflict</span><span class="o">.</span><span class="n">_conflict_where</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON CONFLICT ON CONSTRAINT&#39;</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_conflict_constraint</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="n">updates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_preserve</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_preserve</span><span class="p">:</span>
                <span class="n">excluded</span> <span class="o">=</span> <span class="n">NodeList</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;EXCLUDED&#39;</span><span class="p">),</span> <span class="n">ensure_entity</span><span class="p">(</span><span class="n">column</span><span class="p">)),</span>
                                    <span class="n">glue</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="n">NodeList</span><span class="p">((</span><span class="n">ensure_entity</span><span class="p">(</span><span class="n">column</span><span class="p">),</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">),</span>
                                       <span class="n">excluded</span><span class="p">))</span>
                <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_update</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="c1"># Attempt to resolve string field-names to their respective</span>
                    <span class="c1"># field object, to apply data-type conversions.</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">QualifiedNames</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NodeList</span><span class="p">((</span><span class="n">ensure_entity</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">stmt</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DO UPDATE SET&#39;</span><span class="p">),</span> <span class="n">CommaNodeList</span><span class="p">(</span><span class="n">updates</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_where</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;WHERE&#39;</span><span class="p">),</span> <span class="n">QualifiedNames</span><span class="p">(</span><span class="n">on_conflict</span><span class="o">.</span><span class="n">_where</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">NodeList</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">last_insert_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

    <span class="k">def</span> <span class="nf">rows_affected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="k">def</span> <span class="nf">default_values_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;DEFAULT VALUES&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">session_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">session_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">txn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_transaction</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">txn</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">())</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">session_rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">txn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_transaction</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">txn</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">())</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">in_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">transaction_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">top_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">transactions</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">transactions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">manual_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">__exception_wrapper__</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">__exception_wrapper__</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">batch_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">chunked</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tables</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">sequence_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">create_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">sort_models</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">sort_models</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">truncate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">from_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">bind_refs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bind_backrefs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind_refs</span><span class="o">=</span><span class="n">bind_refs</span><span class="p">,</span> <span class="n">bind_backrefs</span><span class="o">=</span><span class="n">bind_backrefs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind_ctx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">bind_refs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bind_backrefs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_BoundModelsContext</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">bind_refs</span><span class="p">,</span> <span class="n">bind_backrefs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_noop_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Select</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">__pragma__</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="fm">__get__</span><span class="p">,</span> <span class="fm">__set__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SqliteDatabase</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="n">field_types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;BIGAUTO&#39;</span><span class="p">:</span> <span class="n">FIELD</span><span class="o">.</span><span class="n">AUTO</span><span class="p">,</span>
        <span class="s1">&#39;BIGINT&#39;</span><span class="p">:</span> <span class="n">FIELD</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
        <span class="s1">&#39;BOOL&#39;</span><span class="p">:</span> <span class="n">FIELD</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
        <span class="s1">&#39;DOUBLE&#39;</span><span class="p">:</span> <span class="n">FIELD</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
        <span class="s1">&#39;SMALLINT&#39;</span><span class="p">:</span> <span class="n">FIELD</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
        <span class="s1">&#39;UUID&#39;</span><span class="p">:</span> <span class="n">FIELD</span><span class="o">.</span><span class="n">TEXT</span><span class="p">}</span>
    <span class="n">operations</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;LIKE&#39;</span><span class="p">:</span> <span class="s1">&#39;GLOB&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ILIKE&#39;</span><span class="p">:</span> <span class="s1">&#39;LIKE&#39;</span><span class="p">}</span>
    <span class="n">index_schema_prefix</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">limit_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">server_version</span> <span class="o">=</span> <span class="n">__sqlite_version__</span>
    <span class="n">truncate_table</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pragmas&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SqliteDatabase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window_functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extensions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attached</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="n">_sqlite_date_part</span><span class="p">,</span> <span class="s1">&#39;date_part&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="n">_sqlite_date_trunc</span><span class="p">,</span> <span class="s1">&#39;date_trunc&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nulls_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">pragmas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pragmas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span> <span class="o">=</span> <span class="n">pragmas</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SqliteDatabase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_server_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sqlite3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;SQLite driver not installed!&#39;</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">,</span>
                               <span class="n">isolation_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_params</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_conn_hooks</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_add_conn_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attached</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attach_databases</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_pragmas</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_aggregates</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_collations</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_functions</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_window_functions</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_functions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_functions</span><span class="p">:</span>
                <span class="n">table_function</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extensions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_extensions</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_pragmas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pragma</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pragma</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_attach_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attached</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;ATTACH DATABASE &quot;</span><span class="si">%s</span><span class="s1">&quot; AS &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pragma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">SENTINEL</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;PRAGMA </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SENTINEL</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">permanent</span><span class="p">:</span>
                <span class="n">pragmas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span> <span class="ow">or</span> <span class="p">())</span>
                <span class="n">pragmas</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pragmas</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">permanent</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify a permanent pragma without value&#39;</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">cache_size</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;cache_size&#39;</span><span class="p">)</span>
    <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;foreign_keys&#39;</span><span class="p">)</span>
    <span class="n">journal_mode</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;journal_mode&#39;</span><span class="p">)</span>
    <span class="n">journal_size_limit</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;journal_size_limit&#39;</span><span class="p">)</span>
    <span class="n">mmap_size</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;mmap_size&#39;</span><span class="p">)</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;page_size&#39;</span><span class="p">)</span>
    <span class="n">read_uncommitted</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;read_uncommitted&#39;</span><span class="p">)</span>
    <span class="n">synchronous</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;synchronous&#39;</span><span class="p">)</span>
    <span class="n">wal_autocheckpoint</span> <span class="o">=</span> <span class="n">__pragma__</span><span class="p">(</span><span class="s1">&#39;wal_autocheckpoint&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>

    <span class="nd">@timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">==</span> <span class="n">seconds</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">seconds</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="c1"># PySQLite multiplies user timeout by 1000, but the unit of the</span>
            <span class="c1"># timeout PRAGMA is actually milliseconds.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA busy_timeout=</span><span class="si">%d</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_load_aggregates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">create_aggregate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num_params</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_collations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">create_collation</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num_params</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_window_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">create_window_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num_params</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_params</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregates</span><span class="p">[</span><span class="n">name</span> <span class="ow">or</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_aggregates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_params</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_aggregate</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">klass</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">register_collation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">def</span> <span class="nf">_collation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;collate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),)</span>
            <span class="k">return</span> <span class="n">NodeList</span><span class="p">(</span><span class="n">expressions</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">collation</span> <span class="o">=</span> <span class="n">_collation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_collations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">collation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_collation</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">register_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_params</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">[</span><span class="n">name</span> <span class="ow">or</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_params</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">register_window_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_params</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window_functions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_window_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">window_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_params</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_window_function</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">klass</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">register_table_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">klass</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="n">klass</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">table_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_table_function</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">klass</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">unregister_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aggregates</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">unregister_collation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collations</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">unregister_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">unregister_window_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_window_functions</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">unregister_table_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">klass</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_functions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_functions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_load_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">enable_load_extension</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extensions</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extensions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">enable_load_extension</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unload_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extensions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attached</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attached</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s1">&#39;schema &quot;</span><span class="si">%s</span><span class="s1">&quot; already attached.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_attached</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;ATTACH DATABASE &quot;</span><span class="si">%s</span><span class="s1">&quot; AS &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attached</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attached</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;DETACH DATABASE &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lock_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;BEGIN </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">lock_type</span> <span class="k">if</span> <span class="n">lock_type</span> <span class="k">else</span> <span class="s1">&#39;BEGIN&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SELECT name FROM &quot;</span><span class="si">%s</span><span class="s1">&quot;.sqlite_master WHERE &#39;</span>
                                  <span class="s1">&#39;type=? ORDER BY name&#39;</span> <span class="o">%</span> <span class="n">schema</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT name, sql FROM &quot;</span><span class="si">%s</span><span class="s1">&quot;.sqlite_master WHERE type=? &#39;</span>
               <span class="s1">&#39;ORDER BY name&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ViewMetadata</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,))]</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT name, sql FROM &quot;</span><span class="si">%s</span><span class="s1">&quot;.sqlite_master &#39;</span>
                 <span class="s1">&#39;WHERE tbl_name = ? AND type = ? ORDER BY name&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">schema</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">))</span>
        <span class="n">index_to_sql</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

        <span class="c1"># Determine which indexes have a unique constraint.</span>
        <span class="n">unique_indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA &quot;</span><span class="si">%s</span><span class="s1">&quot;.index_list(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">is_unique</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_unique</span><span class="p">:</span>
                <span class="n">unique_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Retrieve the indexed columns.</span>
        <span class="n">index_columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">index_to_sql</span><span class="p">):</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA &quot;</span><span class="si">%s</span><span class="s1">&quot;.index_info(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">index_name</span><span class="p">))</span>
            <span class="n">index_columns</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">IndexMetadata</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">index_to_sql</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="n">index_columns</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="n">name</span> <span class="ow">in</span> <span class="n">unique_indexes</span><span class="p">,</span>
                <span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">index_to_sql</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA &quot;</span><span class="si">%s</span><span class="s1">&quot;.table_info(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">bool</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">table</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA &quot;</span><span class="si">%s</span><span class="s1">&quot;.table_info(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())]</span>

    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;PRAGMA &quot;</span><span class="si">%s</span><span class="s1">&quot;.foreign_key_list(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ForeignKeyMetadata</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_binary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Binary</span>

    <span class="k">def</span> <span class="nf">conflict_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_action</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">and</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;INSERT OR </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_action</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">conflict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># Sqlite prior to 3.24.0 does not support Postgres-style upsert.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="nb">any</span><span class="p">((</span><span class="n">oc</span><span class="o">.</span><span class="n">_preserve</span><span class="p">,</span> <span class="n">oc</span><span class="o">.</span><span class="n">_update</span><span class="p">,</span> <span class="n">oc</span><span class="o">.</span><span class="n">_where</span><span class="p">,</span> <span class="n">oc</span><span class="o">.</span><span class="n">_conflict_target</span><span class="p">,</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">_conflict_constraint</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQLite does not support specifying which values &#39;</span>
                             <span class="s1">&#39;to preserve or update.&#39;</span><span class="p">)</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">_action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">oc</span><span class="o">.</span><span class="n">_action</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">and</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;nothing&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON CONFLICT DO NOTHING&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">oc</span><span class="o">.</span><span class="n">_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">oc</span><span class="o">.</span><span class="n">_preserve</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;If you are not performing any updates (or &#39;</span>
                             <span class="s1">&#39;preserving any INSERTed values), then the &#39;</span>
                             <span class="s1">&#39;conflict resolution action should be set to &#39;</span>
                             <span class="s1">&#39;&quot;NOTHING&quot;.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">oc</span><span class="o">.</span><span class="n">_conflict_constraint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQLite does not support specifying named &#39;</span>
                             <span class="s1">&#39;constraints for conflict resolution.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">oc</span><span class="o">.</span><span class="n">_conflict_target</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQLite requires that a conflict target be &#39;</span>
                             <span class="s1">&#39;specified when doing an upsert.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_on_conflict_update</span><span class="p">(</span><span class="n">oc</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">date_part</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">,</span> <span class="n">python_value</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">truncate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">date_trunc</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">,</span>
                             <span class="n">python_value</span><span class="o">=</span><span class="n">simple_date_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date_field</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">from_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">date_field</span><span class="p">,</span> <span class="s1">&#39;unixepoch&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PostgresqlDatabase</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="n">field_types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;AUTO&#39;</span><span class="p">:</span> <span class="s1">&#39;SERIAL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BIGAUTO&#39;</span><span class="p">:</span> <span class="s1">&#39;BIGSERIAL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BLOB&#39;</span><span class="p">:</span> <span class="s1">&#39;BYTEA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BOOL&#39;</span><span class="p">:</span> <span class="s1">&#39;BOOLEAN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DATETIME&#39;</span><span class="p">:</span> <span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DECIMAL&#39;</span><span class="p">:</span> <span class="s1">&#39;NUMERIC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DOUBLE&#39;</span><span class="p">:</span> <span class="s1">&#39;DOUBLE PRECISION&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UUID&#39;</span><span class="p">:</span> <span class="s1">&#39;UUID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UUIDB&#39;</span><span class="p">:</span> <span class="s1">&#39;BYTEA&#39;</span><span class="p">}</span>
    <span class="n">operations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;REGEXP&#39;</span><span class="p">:</span> <span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;IREGEXP&#39;</span><span class="p">:</span> <span class="s1">&#39;~*&#39;</span><span class="p">}</span>
    <span class="n">param</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>

    <span class="n">commit_select</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">compound_select_parentheses</span> <span class="o">=</span> <span class="n">CSQ_PARENTHESES_ALWAYS</span>
    <span class="n">for_update</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">nulls_ordering</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">returning_clause</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">safe_create_index</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">register_unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">isolation_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_unicode</span> <span class="o">=</span> <span class="n">register_unicode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isolation_level</span> <span class="o">=</span> <span class="n">isolation_level</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PostgresqlDatabase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">psycopg2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;Postgres driver not installed!&#39;</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_unicode</span><span class="p">:</span>
            <span class="n">pg_extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">pg_extensions</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
            <span class="n">pg_extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">pg_extensions</span><span class="o">.</span><span class="n">UNICODEARRAY</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">set_client_encoding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isolation_level</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isolation_level</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_set_server_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">server_version</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">&gt;=</span> <span class="mi">90600</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">safe_create_index</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">is_connection_usable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Returns True if we are idle, running a command, or in an active</span>
        <span class="c1"># connection. If the connection is in an error state or the connection</span>
        <span class="c1"># is otherwise unusable, return False.</span>
        <span class="n">txn_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">get_transaction_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">txn_status</span> <span class="o">&lt;</span> <span class="n">pg_extensions</span><span class="o">.</span><span class="n">TRANSACTION_STATUS_INERROR</span>

    <span class="k">def</span> <span class="nf">last_insert_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cursor</span> <span class="k">if</span> <span class="n">query_type</span> <span class="o">!=</span> <span class="n">Insert</span><span class="o">.</span><span class="n">SIMPLE</span> <span class="k">else</span> <span class="n">cursor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT tablename FROM pg_catalog.pg_tables &#39;</span>
                 <span class="s1">&#39;WHERE schemaname = </span><span class="si">%s</span><span class="s1"> ORDER BY tablename&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;public&#39;</span><span class="p">,))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">table</span> <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT viewname, definition FROM pg_catalog.pg_views &#39;</span>
                 <span class="s1">&#39;WHERE schemaname = </span><span class="si">%s</span><span class="s1"> ORDER BY viewname&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;public&#39;</span><span class="p">,))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ViewMetadata</span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\t</span><span class="s1">;&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                i.relname, idxs.indexdef, idx.indisunique,</span>
<span class="s2">                array_to_string(ARRAY(</span>
<span class="s2">                    SELECT pg_get_indexdef(idx.indexrelid, k + 1, TRUE)</span>
<span class="s2">                    FROM generate_subscripts(idx.indkey, 1) AS k</span>
<span class="s2">                    ORDER BY k), &#39;,&#39;)</span>
<span class="s2">            FROM pg_catalog.pg_class AS t</span>
<span class="s2">            INNER JOIN pg_catalog.pg_index AS idx ON t.oid = idx.indrelid</span>
<span class="s2">            INNER JOIN pg_catalog.pg_class AS i ON idx.indexrelid = i.oid</span>
<span class="s2">            INNER JOIN pg_catalog.pg_indexes AS idxs ON</span>
<span class="s2">                (idxs.tablename = t.relname AND idxs.indexname = i.relname)</span>
<span class="s2">            WHERE t.relname = </span><span class="si">%s</span><span class="s2"> AND t.relkind = </span><span class="si">%s</span><span class="s2"> AND idxs.schemaname = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            ORDER BY idx.indisunique DESC, i.relname;&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;public&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">IndexMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; ;&#39;</span><span class="p">),</span> <span class="n">columns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
                              <span class="n">is_unique</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">is_unique</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT column_name, is_nullable, data_type, column_default</span>
<span class="s2">            FROM information_schema.columns</span>
<span class="s2">            WHERE table_name = </span><span class="si">%s</span><span class="s2"> AND table_schema = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            ORDER BY ordinal_position&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;public&#39;</span><span class="p">))</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_primary_keys</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">null</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT kc.column_name</span>
<span class="s2">            FROM information_schema.table_constraints AS tc</span>
<span class="s2">            INNER JOIN information_schema.key_column_usage AS kc ON (</span>
<span class="s2">                tc.table_name = kc.table_name AND</span>
<span class="s2">                tc.table_schema = kc.table_schema AND</span>
<span class="s2">                tc.constraint_name = kc.constraint_name)</span>
<span class="s2">            WHERE</span>
<span class="s2">                tc.constraint_type = </span><span class="si">%s</span><span class="s2"> AND</span>
<span class="s2">                tc.table_name = </span><span class="si">%s</span><span class="s2"> AND</span>
<span class="s2">                tc.table_schema = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="s1">&#39;PRIMARY KEY&#39;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;public&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">pk</span> <span class="k">for</span> <span class="n">pk</span><span class="p">,</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT DISTINCT</span>
<span class="s2">                kcu.column_name, ccu.table_name, ccu.column_name</span>
<span class="s2">            FROM information_schema.table_constraints AS tc</span>
<span class="s2">            JOIN information_schema.key_column_usage AS kcu</span>
<span class="s2">                ON (tc.constraint_name = kcu.constraint_name AND</span>
<span class="s2">                    tc.constraint_schema = kcu.constraint_schema)</span>
<span class="s2">            JOIN information_schema.constraint_column_usage AS ccu</span>
<span class="s2">                ON (ccu.constraint_name = tc.constraint_name AND</span>
<span class="s2">                    ccu.constraint_schema = tc.constraint_schema)</span>
<span class="s2">            WHERE</span>
<span class="s2">                tc.constraint_type = &#39;FOREIGN KEY&#39; AND</span>
<span class="s2">                tc.table_name = </span><span class="si">%s</span><span class="s2"> AND</span>
<span class="s2">                tc.table_schema = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">or</span> <span class="s1">&#39;public&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ForeignKeyMetadata</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">sequence_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT COUNT(*) FROM pg_class, pg_namespace</span>
<span class="s2">            WHERE relkind=&#39;S&#39;</span>
<span class="s2">                AND pg_class.relnamespace = pg_namespace.oid</span>
<span class="s2">                AND relname=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">sequence</span><span class="p">,))</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_binary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Binary</span>

    <span class="k">def</span> <span class="nf">conflict_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">conflict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">_action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">oc</span><span class="o">.</span><span class="n">_action</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;nothing&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON CONFLICT DO NOTHING&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;update&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The only supported actions for conflict &#39;</span>
                             <span class="s1">&#39;resolution with Postgresql are &quot;ignore&quot; or &#39;</span>
                             <span class="s1">&#39;&quot;update&quot;.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">oc</span><span class="o">.</span><span class="n">_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">oc</span><span class="o">.</span><span class="n">_preserve</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;If you are not performing any updates (or &#39;</span>
                             <span class="s1">&#39;preserving any INSERTed values), then the &#39;</span>
                             <span class="s1">&#39;conflict resolution action should be set to &#39;</span>
                             <span class="s1">&#39;&quot;IGNORE&quot;.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">oc</span><span class="o">.</span><span class="n">_conflict_target</span> <span class="ow">or</span> <span class="n">oc</span><span class="o">.</span><span class="n">_conflict_constraint</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Postgres requires that a conflict target be &#39;</span>
                             <span class="s1">&#39;specified when doing an upsert.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_on_conflict_update</span><span class="p">(</span><span class="n">oc</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">NodeList</span><span class="p">((</span><span class="n">date_part</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;FROM&#39;</span><span class="p">),</span> <span class="n">date_field</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">truncate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_date</span><span class="p">(</span><span class="s1">&#39;EPOCH&#39;</span><span class="p">,</span> <span class="n">date_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">from_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="c1"># Ironically, here, Postgres means &quot;to the Postgresql timestamp type&quot;.</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">date_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_noop_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Select</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">set_time_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timezone</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;set time zone &quot;</span><span class="si">%s</span><span class="s1">&quot;;&#39;</span> <span class="o">%</span> <span class="n">timezone</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MySQLDatabase</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="n">field_types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;AUTO&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER AUTO_INCREMENT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BIGAUTO&#39;</span><span class="p">:</span> <span class="s1">&#39;BIGINT AUTO_INCREMENT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BOOL&#39;</span><span class="p">:</span> <span class="s1">&#39;BOOL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DECIMAL&#39;</span><span class="p">:</span> <span class="s1">&#39;NUMERIC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DOUBLE&#39;</span><span class="p">:</span> <span class="s1">&#39;DOUBLE PRECISION&#39;</span><span class="p">,</span>
        <span class="s1">&#39;FLOAT&#39;</span><span class="p">:</span> <span class="s1">&#39;FLOAT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UUID&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(40)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UUIDB&#39;</span><span class="p">:</span> <span class="s1">&#39;VARBINARY(16)&#39;</span><span class="p">}</span>
    <span class="n">operations</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;LIKE&#39;</span><span class="p">:</span> <span class="s1">&#39;LIKE BINARY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ILIKE&#39;</span><span class="p">:</span> <span class="s1">&#39;LIKE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;REGEXP&#39;</span><span class="p">:</span> <span class="s1">&#39;REGEXP BINARY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IREGEXP&#39;</span><span class="p">:</span> <span class="s1">&#39;REGEXP&#39;</span><span class="p">,</span>
        <span class="s1">&#39;XOR&#39;</span><span class="p">:</span> <span class="s1">&#39;XOR&#39;</span><span class="p">}</span>
    <span class="n">param</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="s1">&#39;``&#39;</span>

    <span class="n">commit_select</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">compound_select_parentheses</span> <span class="o">=</span> <span class="n">CSQ_PARENTHESES_UNNESTED</span>
    <span class="n">for_update</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">index_using_precedes_table</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">limit_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">safe_create_index</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">safe_drop_index</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sql_mode</span> <span class="o">=</span> <span class="s1">&#39;PIPES_AS_CONCAT&#39;</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;charset&#39;</span><span class="p">:</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sql_mode&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_mode</span><span class="p">,</span>
            <span class="s1">&#39;use_unicode&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;password&#39;</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">mysql_passwd</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;passwd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MySQLDatabase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mysql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;MySQL driver not installed!&#39;</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_set_server_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version_raw</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">server_version</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">version_raw</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_server_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_server_version</span><span class="p">(</span><span class="n">version_raw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_server_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;maria&#39;</span> <span class="ow">in</span> <span class="n">version</span><span class="p">:</span>
            <span class="n">match_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(1\d\.\d+\.\d+)&#39;</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">match_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d\.\d+\.\d+)&#39;</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to determine MySQL version: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Unable to determine version!</span>

    <span class="k">def</span> <span class="nf">default_values_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;() VALUES ()&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT table_name FROM information_schema.tables &#39;</span>
                 <span class="s1">&#39;WHERE table_schema = DATABASE() AND table_type != </span><span class="si">%s</span><span class="s1"> &#39;</span>
                 <span class="s1">&#39;ORDER BY table_name&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">table</span> <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;VIEW&#39;</span><span class="p">,))]</span>

    <span class="k">def</span> <span class="nf">get_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT table_name, view_definition &#39;</span>
                 <span class="s1">&#39;FROM information_schema.views &#39;</span>
                 <span class="s1">&#39;WHERE table_schema = DATABASE() ORDER BY table_name&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ViewMetadata</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SHOW INDEX FROM `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">unique</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">indexes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[])</span>
            <span class="n">indexes</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">IndexMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">indexes</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT column_name, is_nullable, data_type, column_default</span>
<span class="s2">            FROM information_schema.columns</span>
<span class="s2">            WHERE table_name = </span><span class="si">%s</span><span class="s2"> AND table_schema = DATABASE()&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,))</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_primary_keys</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">null</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SHOW INDEX FROM `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span>
                <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PRIMARY&#39;</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())]</span>

    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT column_name, referenced_table_name, referenced_column_name</span>
<span class="s2">            FROM information_schema.key_column_usage</span>
<span class="s2">            WHERE table_name = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                AND table_schema = DATABASE()</span>
<span class="s2">                AND referenced_table_name IS NOT NULL</span>
<span class="s2">                AND referenced_column_name IS NOT NULL&quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,))</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">ForeignKeyMetadata</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">dest_table</span><span class="p">,</span> <span class="n">dest_column</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">dest_table</span><span class="p">,</span> <span class="n">dest_column</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_binary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mysql</span><span class="o">.</span><span class="n">Binary</span>

    <span class="k">def</span> <span class="nf">conflict_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_action</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;INSERT IGNORE&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;update&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Un-supported action for conflict resolution. &#39;</span>
                             <span class="s1">&#39;MySQL supports REPLACE, IGNORE and UPDATE.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">conflict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_where</span> <span class="ow">or</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_conflict_target</span> <span class="ow">or</span> \
           <span class="n">on_conflict</span><span class="o">.</span><span class="n">_conflict_constraint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;MySQL does not support the specification of &#39;</span>
                             <span class="s1">&#39;where clauses or conflict targets for conflict &#39;</span>
                             <span class="s1">&#39;resolution.&#39;</span><span class="p">)</span>

        <span class="n">updates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_preserve</span><span class="p">:</span>
            <span class="c1"># Here we need to determine which function to use, which varies</span>
            <span class="c1"># depending on the MySQL server version. MySQL and MariaDB prior to</span>
            <span class="c1"># 10.3.3 use &quot;VALUES&quot;, while MariaDB 10.3.3+ use &quot;VALUE&quot;.</span>
            <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
            <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">VALUE_FN</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">VALUE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">VALUE_FN</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">VALUES</span>

            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_preserve</span><span class="p">:</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">ensure_entity</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="n">NodeList</span><span class="p">((</span>
                    <span class="n">ensure_entity</span><span class="p">(</span><span class="n">column</span><span class="p">),</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">),</span>
                    <span class="n">VALUE_FN</span><span class="p">(</span><span class="n">entity</span><span class="p">)))</span>
                <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_update</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">on_conflict</span><span class="o">.</span><span class="n">_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="c1"># Attempt to resolve string field-names to their respective</span>
                    <span class="c1"># field object, to apply data-type conversions.</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NodeList</span><span class="p">((</span><span class="n">ensure_entity</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">updates</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NodeList</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON DUPLICATE KEY UPDATE&#39;</span><span class="p">),</span>
                             <span class="n">CommaNodeList</span><span class="p">(</span><span class="n">updates</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">extract_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">NodeList</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="n">date_part</span><span class="p">),</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;FROM&#39;</span><span class="p">),</span> <span class="n">date_field</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">truncate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_part</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">date_field</span><span class="p">,</span> <span class="n">__mysql_date_trunc__</span><span class="p">[</span><span class="n">date_part</span><span class="p">],</span>
                              <span class="n">python_value</span><span class="o">=</span><span class="n">simple_date_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="n">date_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">from_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">FROM_UNIXTIME</span><span class="p">(</span><span class="n">date_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_noop_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;DO 0&#39;</span><span class="p">)</span>


<span class="c1"># TRANSACTION CONTROL.</span>


<span class="k">class</span> <span class="nc">_manual</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">top_transaction</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">_manual</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot enter manual commit block while a &#39;</span>
                             <span class="s1">&#39;transaction is active.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">push_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pop_transaction</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Transaction stack corrupted while exiting &#39;</span>
                             <span class="s1">&#39;manual commit block.&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_atomic</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">top_transaction</span><span class="p">(),</span> <span class="n">_manual</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot enter atomic commit block while in &#39;</span>
                             <span class="s1">&#39;manual commit mode.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">savepoint</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_transaction</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_begin_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_begin_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">push_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pop_transaction</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_savepoint</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span> <span class="ow">or</span> <span class="s1">&#39;s&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">quote</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;RELEASE SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s1">&#39;ROLLBACK TO SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>


<span class="c1"># CURSOR REPRESENTATIONS.</span>


<span class="k">class</span> <span class="nc">CursorWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_cache</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">populated</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_cache</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ResultIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fill_cache</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fill_cache</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_cache</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_cache</span><span class="p">(</span><span class="n">item</span> <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_cache</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;CursorWrapper only supports integer and slice &#39;</span>
                             <span class="s1">&#39;indexes.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>  <span class="c1"># Lazy initialization.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Efficient one-pass iteration over the result set.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>

    <span class="k">def</span> <span class="nf">fill_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Negative values are not supported.&#39;</span><span class="p">)</span>

        <span class="n">iterator</span> <span class="o">=</span> <span class="n">ResultIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">iterator</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">populated</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">iterator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>


<span class="k">class</span> <span class="nc">DictCursorWrapper</span><span class="p">(</span><span class="n">CursorWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_initialize_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">description</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

    <span class="n">initialize</span> <span class="o">=</span> <span class="n">_initialize_columns</span>

    <span class="k">def</span> <span class="nf">_row_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># Do not overwrite.</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="n">process_row</span> <span class="o">=</span> <span class="n">_row_to_dict</span>


<span class="k">class</span> <span class="nc">NamedTupleCursorWrapper</span><span class="p">(</span><span class="n">CursorWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuple_class</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
            <span class="s1">&#39;Row&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">description</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuple_class</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ObjectCursorWrapper</span><span class="p">(</span><span class="n">DictCursorWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">constructor</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ObjectCursorWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">constructor</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">row_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_to_dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="o">**</span><span class="n">row_dict</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ResultIterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor_wrapper</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor_wrapper</span> <span class="o">=</span> <span class="n">cursor_wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_wrapper</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_wrapper</span><span class="o">.</span><span class="n">row_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_wrapper</span><span class="o">.</span><span class="n">populated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor_wrapper</span><span class="o">.</span><span class="n">iterate</span><span class="p">()</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_wrapper</span><span class="o">.</span><span class="n">row_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span>

<span class="c1"># FIELDS</span>

<span class="k">class</span> <span class="nc">FieldAccessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ForeignKeyAccessor</span><span class="p">(</span><span class="n">FieldAccessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyAccessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>

    <span class="k">def</span> <span class="nf">get_rel_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">rel_field</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">DoesNotExist</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rel_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">):</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fk_value</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="o">!=</span> <span class="n">fk_value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NoQueryForeignKeyAccessor</span><span class="p">(</span><span class="n">ForeignKeyAccessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_rel_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">DoesNotExist</span>


<span class="k">class</span> <span class="nc">BackrefAccessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span>
                    <span class="o">.</span><span class="n">select</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">dest</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">ObjectIdAccessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gives direct access to the underlying id&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Pull the object-id from the related object if it is not set.</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">:</span>
                <span class="n">rel_obj</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">__rel__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
    <span class="n">_field_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">accessor_class</span> <span class="o">=</span> <span class="n">FieldAccessor</span>
    <span class="n">auto_increment</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">default_index_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;DEFAULT&#39;</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sequence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unindexed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">help_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">db_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_hidden</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">__deprecated__</span><span class="p">(</span><span class="s1">&#39;&quot;db_column&quot; has been deprecated in favor of &#39;</span>
                           <span class="s1">&#39;&quot;column_name&quot; for Field objects.&#39;</span><span class="p">)</span>
            <span class="n">column_name</span> <span class="o">=</span> <span class="n">db_column</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">null</span> <span class="o">=</span> <span class="n">null</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span> <span class="o">=</span> <span class="n">column_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="n">primary_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span>  <span class="c1"># List of column constraints.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span>  <span class="c1"># Name of sequence, e.g. foo_id_seq.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collation</span> <span class="o">=</span> <span class="n">collation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unindexed</span> <span class="o">=</span> <span class="n">unindexed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">choices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help_text</span> <span class="o">=</span> <span class="n">help_text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose_name</span> <span class="o">=</span> <span class="n">verbose_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_type</span> <span class="o">=</span> <span class="n">index_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_index_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden</span> <span class="o">=</span> <span class="n">_hidden</span>

        <span class="c1"># Used internally for recovering the order in which Fields were defined</span>
        <span class="c1"># on the Model class.</span>
        <span class="n">Field</span><span class="o">.</span><span class="n">_field_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="n">Field</span><span class="o">.</span><span class="n">_field_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">: (unbound)&gt;&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span> <span class="ow">or</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">set_attribute</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accessor_class</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_value</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_key</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">ddl_datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">field_types</span><span class="p">:</span>
            <span class="n">column_type</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">field_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_type</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">field_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_type</span>

        <span class="n">modifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_modifiers</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">column_type</span> <span class="ow">and</span> <span class="n">modifiers</span><span class="p">:</span>
            <span class="n">modifier_literal</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modifiers</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="n">modifier_literal</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ddl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="p">[</span><span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">)]</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddl_datatype</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="p">:</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unindexed</span><span class="p">:</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;UNINDEXED&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;NOT NULL&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;PRIMARY KEY&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;DEFAULT NEXTVAL(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collation</span><span class="p">:</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;COLLATE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">collation</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">NodeList</span><span class="p">(</span><span class="n">accum</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IntegerField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;INT&#39;</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">BigIntegerField</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;BIGINT&#39;</span>


<span class="k">class</span> <span class="nc">SmallIntegerField</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;SMALLINT&#39;</span>


<span class="k">class</span> <span class="nc">AutoField</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">):</span>
    <span class="n">auto_increment</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;AUTO&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;primary_key&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> must always be a primary key.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;primary_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BigAutoField</span><span class="p">(</span><span class="n">AutoField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;BIGAUTO&#39;</span>


<span class="k">class</span> <span class="nc">IdentityField</span><span class="p">(</span><span class="n">AutoField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;INT GENERATED BY DEFAULT AS IDENTITY&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_always</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_always</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;INT GENERATED ALWAYS AS IDENTITY&#39;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IdentityField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrimaryKeyField</span><span class="p">(</span><span class="n">AutoField</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">__deprecated__</span><span class="p">(</span><span class="s1">&#39;&quot;PrimaryKeyField&quot; has been renamed to &quot;AutoField&quot;. &#39;</span>
                       <span class="s1">&#39;Please update your code accordingly as this will be &#39;</span>
                       <span class="s1">&#39;completely removed in a subsequent release.&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrimaryKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FloatField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;FLOAT&#39;</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">DoubleField</span><span class="p">(</span><span class="n">FloatField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;DOUBLE&#39;</span>


<span class="k">class</span> <span class="nc">DecimalField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;DECIMAL&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_digits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">decimal_places</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">auto_round</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">rounding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_digits</span> <span class="o">=</span> <span class="n">max_digits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decimal_places</span> <span class="o">=</span> <span class="n">decimal_places</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_round</span> <span class="o">=</span> <span class="n">auto_round</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rounding</span> <span class="o">=</span> <span class="n">rounding</span> <span class="ow">or</span> <span class="n">decimal</span><span class="o">.</span><span class="n">DefaultContext</span><span class="o">.</span><span class="n">rounding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exp</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DecimalField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_digits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">D</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_round</span><span class="p">:</span>
            <span class="n">decimal_value</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">text_type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">decimal_value</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp</span><span class="p">,</span> <span class="n">rounding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rounding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">text_type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_StringField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="n">StringExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="n">StringExpression</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CharField</span><span class="p">(</span><span class="n">_StringField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;VARCHAR&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CharField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="ow">and</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">FixedCharField</span><span class="p">(</span><span class="n">CharField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;CHAR&#39;</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FixedCharField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">TextField</span><span class="p">(</span><span class="n">_StringField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;TEXT&#39;</span>


<span class="k">class</span> <span class="nc">BlobField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;BLOB&#39;</span>

    <span class="k">def</span> <span class="nf">_db_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span> <span class="o">=</span> <span class="nb">bytearray</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_binary_type</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span> <span class="o">=</span> <span class="nb">bytearray</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">):</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">attach_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_hook</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db_hook</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>

        <span class="c1"># Attach a hook to the model metadata; in the event the database is</span>
        <span class="c1"># changed or set at run-time, we will be sure to apply our callback and</span>
        <span class="c1"># use the proper data-type for our database driver.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">_db_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_hook</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BlobField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;raw_unicode_escape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">BitField</span><span class="p">(</span><span class="n">BitwiseMixin</span><span class="p">,</span> <span class="n">BigIntegerField</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BitField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_flag</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_flag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__current_flag</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__current_flag</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>

        <span class="k">class</span> <span class="nc">FlagDescriptor</span><span class="p">(</span><span class="n">ColumnBase</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_field</span> <span class="o">=</span> <span class="n">field</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">FlagDescriptor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">bin_and</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">bin_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
            <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">is_set</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_set</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value must be either True or False&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">is_set</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_field</span><span class="o">.</span><span class="n">bin_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FlagDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BigBitFieldData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_ensure_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">byte_num</span><span class="p">,</span> <span class="n">byte_offset</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">cur_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur_size</span> <span class="o">&lt;=</span> <span class="n">byte_num</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">((</span><span class="n">byte_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">byte_num</span><span class="p">,</span> <span class="n">byte_offset</span>

    <span class="k">def</span> <span class="nf">set_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">byte_num</span><span class="p">,</span> <span class="n">byte_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_length</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">byte_offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">byte_num</span><span class="p">,</span> <span class="n">byte_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_length</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">byte_offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">toggle_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">byte_num</span><span class="p">,</span> <span class="n">byte_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_length</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">byte_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">byte_offset</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">is_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">byte_num</span><span class="p">,</span> <span class="n">byte_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_length</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">byte_offset</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BigBitFieldAccessor</span><span class="p">(</span><span class="n">FieldAccessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span>
        <span class="k">return</span> <span class="n">BigBitFieldData</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">buffer_type</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BigBitFieldData</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes_type</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value must be either a bytes, memoryview or &#39;</span>
                             <span class="s1">&#39;BigBitFieldData instance.&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BigBitFieldAccessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BigBitField</span><span class="p">(</span><span class="n">BlobField</span><span class="p">):</span>
    <span class="n">accessor_class</span> <span class="o">=</span> <span class="n">BigBitFieldAccessor</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BigBitField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bytes_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">UUIDField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;UUID&#39;</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
            <span class="c1"># Hex string. No transformation is necessary.</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
            <span class="c1"># Allow raw binary representation.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">hex</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">BinaryUUIDField</span><span class="p">(</span><span class="n">BlobField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;UUIDB&#39;</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
            <span class="c1"># Raw binary value. No transformation is necessary.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
            <span class="c1"># Allow hex string representation.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">hex</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;value for binary UUID field must be UUID(), &#39;</span>
                             <span class="s1">&#39;a hexadecimal string, or a bytes object.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_date_part</span><span class="p">(</span><span class="n">date_part</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">extract_date</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dec</span>

<span class="k">def</span> <span class="nf">format_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">formats</span><span class="p">,</span> <span class="n">post_process</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">post_process</span> <span class="o">=</span> <span class="n">post_process</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">post_process</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">simple_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">_BaseFormattedField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">formats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">formats</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DateTimeField</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;DATETIME&#39;</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">truncate_date</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="n">year</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">))</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">))</span>
    <span class="n">day</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">))</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">))</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">))</span>
    <span class="n">second</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">DateField</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;DATE&#39;</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">truncate_date</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="n">year</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">))</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">))</span>
    <span class="n">day</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">TimeField</span><span class="p">(</span><span class="n">_BaseFormattedField</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;TIME&#39;</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%H:%M&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">min</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">hour</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">))</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">))</span>
    <span class="n">second</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_date_part</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_timestamp_date_part</span><span class="p">(</span><span class="n">date_part</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span> <span class="o">/</span> <span class="n">Value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">extract_date</span><span class="p">(</span><span class="n">date_part</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">from_timestamp</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dec</span>


<span class="k">class</span> <span class="nc">TimestampField</span><span class="p">(</span><span class="n">BigIntegerField</span><span class="p">):</span>
    <span class="c1"># Support second -&gt; microsecond resolution.</span>
    <span class="n">valid_resolutions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_resolutions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;TimestampField resolution must be one of: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_resolutions</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticks_to_microsecond</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">utc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>
        <span class="n">dflt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">dflt</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TimestampField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">local_to_utc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="c1"># Convert naive local datetime into naive UTC, e.g.:</span>
        <span class="c1"># 2019-03-01T12:00:00 (local=US/Central) -&gt; 2019-03-01T18:00:00.</span>
        <span class="c1"># 2019-05-01T12:00:00 (local=US/Central) -&gt; 2019-05-01T17:00:00.</span>
        <span class="c1"># 2019-03-01T12:00:00 (local=UTC)        -&gt; 2019-03-01T12:00:00.</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))[:</span><span class="mi">6</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">utc_to_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="c1"># Convert a naive UTC datetime into local time, e.g.:</span>
        <span class="c1"># 2019-03-01T18:00:00 (local=US/Central) -&gt; 2019-03-01T12:00:00.</span>
        <span class="c1"># 2019-05-01T17:00:00 (local=US/Central) -&gt; 2019-05-01T12:00:00.</span>
        <span class="c1"># 2019-03-01T12:00:00 (local=UTC)        -&gt; 2019-03-01T12:00:00.</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="p">:</span>
            <span class="c1"># If utc-mode is on, then we assume all naive datetimes are in UTC.</span>
            <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">))</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">*</span> <span class="o">.</span><span class="mi">000001</span><span class="p">)</span>
            <span class="n">timestamp</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">ticks</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>
                <span class="n">microseconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticks</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticks_to_microsecond</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">microseconds</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">microseconds</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="n">microseconds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">from_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span> <span class="o">/</span> <span class="n">Value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">from_timestamp</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

    <span class="n">year</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_timestamp_date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">))</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_timestamp_date_part</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">))</span>
    <span class="n">day</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_timestamp_date_part</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">))</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_timestamp_date_part</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">))</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_timestamp_date_part</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">))</span>
    <span class="n">second</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_timestamp_date_part</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">IPField</span><span class="p">(</span><span class="n">BigIntegerField</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;!I&#39;</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">val</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!I&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">BooleanField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;BOOL&#39;</span>
    <span class="n">adapt</span> <span class="o">=</span> <span class="nb">bool</span>


<span class="k">class</span> <span class="nc">BareField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adapt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BareField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adapt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="n">adapt</span>

    <span class="k">def</span> <span class="nf">ddl_datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span>


<span class="k">class</span> <span class="nc">ForeignKeyField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">accessor_class</span> <span class="o">=</span> <span class="n">ForeignKeyAccessor</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">on_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deferrable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_deferred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rel_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">object_id_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">lazy_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># If lazy_load is disable, we use a different descriptor/accessor that</span>
        <span class="c1"># will ensure we don&#39;t accidentally perform a query.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lazy_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accessor_class</span> <span class="o">=</span> <span class="n">NoQueryForeignKeyAccessor</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rel_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">__deprecated__</span><span class="p">(</span><span class="s1">&#39;&quot;rel_model&quot; has been deprecated in favor of &#39;</span>
                           <span class="s1">&#39;&quot;model&quot; for ForeignKeyField objects.&#39;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">rel_model</span>
        <span class="k">if</span> <span class="n">to_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">__deprecated__</span><span class="p">(</span><span class="s1">&#39;&quot;to_field&quot; has been deprecated in favor of &#39;</span>
                           <span class="s1">&#39;&quot;field&quot; for ForeignKeyField objects.&#39;</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">to_field</span>
        <span class="k">if</span> <span class="n">related_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">__deprecated__</span><span class="p">(</span><span class="s1">&#39;&quot;related_name&quot; has been deprecated in favor of &#39;</span>
                           <span class="s1">&#39;&quot;backref&quot; for Field objects.&#39;</span><span class="p">)</span>
            <span class="n">backref</span> <span class="o">=</span> <span class="n">related_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_self_reference</span> <span class="o">=</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_backref</span> <span class="o">=</span> <span class="n">backref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_delete</span> <span class="o">=</span> <span class="n">on_delete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_update</span> <span class="o">=</span> <span class="n">on_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span> <span class="o">=</span> <span class="n">deferrable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span> <span class="o">=</span> <span class="n">_deferred</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span> <span class="o">=</span> <span class="n">object_id_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_load</span> <span class="o">=</span> <span class="n">lazy_load</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">field_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="p">,</span> <span class="n">AutoField</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">field_type</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="p">,</span> <span class="n">BigAutoField</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">BigIntegerField</span><span class="o">.</span><span class="n">field_type</span>
        <span class="k">return</span> <span class="n">IntegerField</span><span class="o">.</span><span class="n">field_type</span>

    <span class="k">def</span> <span class="nf">get_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="p">,</span> <span class="n">AutoField</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">get_modifiers</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_modifiers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_id&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span> <span class="o">+=</span> <span class="s1">&#39;_id&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ForeignKeyField &quot;</span><span class="si">%s</span><span class="s1">&quot;.&quot;</span><span class="si">%s</span><span class="s1">&quot; specifies an &#39;</span>
                             <span class="s1">&#39;object_id_name that conflicts with its field &#39;</span>
                             <span class="s1">&#39;name.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_self_reference</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>

        <span class="c1"># Bind field before assigning backref, so field is bound when</span>
        <span class="c1"># calling declared_backref() (if callable).</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span>

        <span class="k">if</span> <span class="n">callable_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_backref</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_backref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_backref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_backref</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_set&#39;</span> <span class="o">%</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="n">set_attribute</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_id_name</span><span class="p">,</span> <span class="n">ObjectIdAccessor</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;!+&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span><span class="p">,</span> <span class="n">BackrefAccessor</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">foreign_key_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;FOREIGN KEY&#39;</span><span class="p">),</span>
            <span class="n">EnclosedNodeList</span><span class="p">((</span><span class="bp">self</span><span class="p">,)),</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;REFERENCES&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span>
            <span class="n">EnclosedNodeList</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_field</span><span class="p">,))]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_delete</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON DELETE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_delete</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_update</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON UPDATE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_update</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DEFERRABLE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">NodeList</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
            <span class="c1"># Prevent recursion error when deep-copying.</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot look-up non-existant &quot;__&quot; methods.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Foreign-key has no attribute </span><span class="si">%s</span><span class="s1">, nor is it a &#39;</span>
                             <span class="s1">&#39;valid field on the related model.&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DeferredForeignKey</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">_unresolved</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_model_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model_name</span> <span class="o">=</span> <span class="n">rel_model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">DeferredForeignKey</span><span class="o">.</span><span class="n">_unresolved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DeferredForeignKey</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">column_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_name&#39;</span><span class="p">),</span>
            <span class="n">null</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;null&#39;</span><span class="p">))</span>

    <span class="fm">__hash__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__hash__</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DeferredForeignKey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model_name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">field_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_model</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">rel_model</span><span class="p">,</span> <span class="n">_deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">field_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">model_cls</span><span class="p">):</span>
        <span class="n">unresolved</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DeferredForeignKey</span><span class="o">.</span><span class="n">_unresolved</span><span class="p">,</span>
                            <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_order&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">unresolved</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dr</span><span class="o">.</span><span class="n">rel_model_name</span> <span class="o">==</span> <span class="n">model_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">dr</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model_cls</span><span class="p">)</span>
                <span class="n">DeferredForeignKey</span><span class="o">.</span><span class="n">_unresolved</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DeferredThroughModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">through_model</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">src_model</span><span class="p">,</span> <span class="n">m2mfield</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refs</span><span class="p">:</span>
            <span class="n">m2mfield</span><span class="o">.</span><span class="n">through_model</span> <span class="o">=</span> <span class="n">through_model</span>
            <span class="n">src_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">m2mfield</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MetaField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="n">column_name</span> <span class="o">=</span> <span class="n">default</span> <span class="o">=</span> <span class="n">model</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">primary_key</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">ManyToManyFieldAccessor</span><span class="p">(</span><span class="n">FieldAccessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManyToManyFieldAccessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">through_model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">through_model</span>
        <span class="n">src_fks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_refs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
        <span class="n">dest_fks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_refs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">src_fks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot find foreign-key to &quot;</span><span class="si">%s</span><span class="s1">&quot; on &quot;</span><span class="si">%s</span><span class="s1">&quot; model.&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">through_model</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">dest_fks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot find foreign-key to &quot;</span><span class="si">%s</span><span class="s1">&quot; on &quot;</span><span class="si">%s</span><span class="s1">&quot; model.&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">through_model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_fk</span> <span class="o">=</span> <span class="n">src_fks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_fk</span> <span class="o">=</span> <span class="n">dest_fks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_query</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_query</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_fk</span><span class="o">.</span><span class="n">backref</span> <span class="o">!=</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">backref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_fk</span><span class="o">.</span><span class="n">backref</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backref</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_fk</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">backref</span><span class="p">]</span>

            <span class="n">src_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_fk</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ManyToManyQuery</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through_model</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_fk</span> <span class="o">==</span> <span class="n">src_id</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">force_query</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">clear_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ManyToManyField</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
    <span class="n">accessor_class</span> <span class="o">=</span> <span class="n">ManyToManyFieldAccessor</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">through_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">on_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_is_backref</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">through_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">through_model</span><span class="p">,</span> <span class="n">DeferredThroughModel</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">is_model</span><span class="p">(</span><span class="n">through_model</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unexpected value for through_model. Expected &#39;</span>
                                <span class="s1">&#39;Model or DeferredThroughModel.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_backref</span> <span class="ow">and</span> <span class="p">(</span><span class="n">on_delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">on_update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify on_delete or on_update when &#39;</span>
                                 <span class="s1">&#39;through_model is specified.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="o">=</span> <span class="n">backref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span> <span class="o">=</span> <span class="n">through_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_delete</span> <span class="o">=</span> <span class="n">on_delete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_update</span> <span class="o">=</span> <span class="n">on_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_backref</span> <span class="o">=</span> <span class="n">_is_backref</span>

    <span class="k">def</span> <span class="nf">_get_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ManyToManyFieldAccessor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="p">,</span> <span class="n">DeferredThroughModel</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">ManyToManyField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_backref</span><span class="p">:</span>
            <span class="n">many_to_many_field</span> <span class="o">=</span> <span class="n">ManyToManyField</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">backref</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">through_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through_model</span><span class="p">,</span>
                <span class="n">on_delete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_delete</span><span class="p">,</span>
                <span class="n">on_update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_update</span><span class="p">,</span>
                <span class="n">_is_backref</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backref</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backref</span><span class="p">,</span> <span class="n">many_to_many_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">model</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">((</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_backref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
            <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_backref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_model</span><span class="p">)))]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">through_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_through_model</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span>

    <span class="nd">@through_model</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">through_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_through_model</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_create_through_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_models</span><span class="p">()</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_name</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)]</span>

        <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
            <span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">schema</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_through&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">((</span><span class="n">lhs</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rhs</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                 <span class="kc">True</span><span class="p">),)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;on_delete&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_delete</span><span class="p">,</span> <span class="s1">&#39;on_update&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_update</span><span class="p">}</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">lhs</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">),</span>
            <span class="n">rhs</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">),</span>
            <span class="s1">&#39;Meta&#39;</span><span class="p">:</span> <span class="n">Meta</span><span class="p">}</span>

        <span class="n">klass_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">Through&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lhs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">rhs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">klass_name</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,),</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_through_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># XXX: Deprecated. Just use the &quot;through_model&quot; property.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">through_model</span>


<span class="k">class</span> <span class="nc">VirtualField</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
    <span class="n">field_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Field</span> <span class="o">=</span> <span class="n">field_class</span> <span class="k">if</span> <span class="n">field_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span> <span class="k">if</span> <span class="n">Field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VirtualField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_instance</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accessor_class</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">CompositeKey</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">field_names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="n">field_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_field_names</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">safe_field_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_field_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_field_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">safe_name</span>
                                      <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_field_names</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_field_names</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;A list or tuple must be used to set the value of &#39;</span>
                            <span class="s1">&#39;a composite primary key.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The length of the value must equal the number &#39;</span>
                             <span class="s1">&#39;of columns of the composite primary key.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">field_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">other</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="c1"># If the composite PK is being selected, do not use parens. Elsewhere,</span>
        <span class="c1"># such as in an expression, we want to use parentheses and treat it as</span>
        <span class="c1"># a row value.</span>
        <span class="n">parens</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">!=</span> <span class="n">SCOPE_SOURCE</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">NodeList</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">],</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="n">parens</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_SortedFieldList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_keys&#39;</span><span class="p">,</span> <span class="s1">&#39;_items&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_sort_key</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">bisect_left</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">bisect_right</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">_sort_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_sort_key</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">bisect_left</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>


<span class="c1"># MODELS</span>


<span class="k">class</span> <span class="nc">SchemaManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">context_options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="n">context_options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">,</span> <span class="n">SCOPE_VALUES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_options</span> <span class="o">=</span> <span class="n">context_options</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>
        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;database attribute does not appear to &#39;</span>
                                       <span class="s1">&#39;be set on the model: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span>

    <span class="nd">@database</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_create_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_sql_context</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">context_options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">is_temp</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;temporary&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_context</span><span class="p">()</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;CREATE TEMPORARY TABLE &#39;</span> <span class="k">if</span> <span class="n">is_temp</span> <span class="k">else</span> <span class="s1">&#39;CREATE TABLE &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">safe</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;IF NOT EXISTS &#39;</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
            <span class="n">pk_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">column</span>
                          <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">field_names</span><span class="p">]</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NodeList</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;PRIMARY KEY&#39;</span><span class="p">),</span>
                                         <span class="n">EnclosedNodeList</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">))))</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ddl</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_key_constraint</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>

        <span class="n">constraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_table_option_sql</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">EnclosedNodeList</span><span class="p">(</span><span class="n">columns</span> <span class="o">+</span> <span class="n">constraints</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">table_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">table_settings</span> <span class="o">=</span> <span class="n">ensure_tuple</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">table_settings</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;table_settings must be strings&#39;</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">without_rowid</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; WITHOUT ROWID&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">_create_table_option_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">options</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">accum</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_model</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NodeList</span><span class="p">((</span><span class="n">SQL</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">),</span> <span class="n">glue</span><span class="o">=</span><span class="s1">&#39;=&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">accum</span>

    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span><span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_create_table_as</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_context</span><span class="p">()</span>
               <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;CREATE TEMPORARY TABLE &#39;</span>
                        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temporary&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;CREATE TABLE &#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">safe</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;IF NOT EXISTS &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ctx</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_table_as</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_table_as</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_context</span><span class="p">()</span>
               <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS &#39;</span> <span class="k">if</span> <span class="n">safe</span> <span class="k">else</span> <span class="s1">&#39;DROP TABLE &#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cascade&#39;</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; CASCADE&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restrict&#39;</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; RESTRICT&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_drop_table</span><span class="p">(</span><span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_truncate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_identity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">truncate_table</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_context</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;DELETE FROM &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_context</span><span class="p">()</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;TRUNCATE TABLE &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">restart_identity</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; RESTART IDENTITY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cascade</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; CASCADE&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">truncate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_identity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_truncate_table</span><span class="p">(</span><span class="n">restart_identity</span><span class="p">,</span> <span class="n">cascade</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_create_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_to_index</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">_create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">Index</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">safe_create_index</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">safe</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">index</span><span class="o">.</span><span class="n">_safe</span> <span class="o">!=</span> <span class="n">safe</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">safe</span><span class="p">(</span><span class="n">safe</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_context</span><span class="p">()</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_indexes</span><span class="p">(</span><span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_drop_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_to_index</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">Index</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_drop_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">safe</span><span class="p">):</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s1">&#39;DROP INDEX &#39;</span>
        <span class="k">if</span> <span class="n">safe</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">safe_drop_index</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">+=</span> <span class="s1">&#39;IF EXISTS &#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_schema</span><span class="p">:</span>
            <span class="n">index_name</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_name</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span>
                <span class="o">.</span><span class="n">_create_context</span><span class="p">()</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">index_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">drop_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drop_indexes</span><span class="p">(</span><span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Sequences are either not supported, or are not &#39;</span>
                             <span class="s1">&#39;defined for &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sequence_for_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_sequences</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">sequence_exists</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span>
                    <span class="o">.</span><span class="n">_create_context</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;CREATE SEQUENCE &#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence_for_field</span><span class="p">(</span><span class="n">field</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">create_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">seq_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_sequence</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq_ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">seq_ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_sequences</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">sequence_exists</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span>
                    <span class="o">.</span><span class="n">_create_context</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;DROP SEQUENCE &#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence_for_field</span><span class="p">(</span><span class="n">field</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">drop_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">seq_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drop_sequence</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq_ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">seq_ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;fk_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_refs_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
                                     <span class="n">field</span><span class="o">.</span><span class="n">column_name</span><span class="p">,</span>
                                     <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span>
                <span class="o">.</span><span class="n">_create_context</span><span class="p">()</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE &#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; ADD CONSTRAINT &#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="n">_truncate_constraint_name</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
                <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_key_constraint</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">create_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_foreign_key</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_sequence</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">table_options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_sequences</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">safe</span><span class="p">,</span> <span class="o">**</span><span class="n">table_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_indexes</span><span class="p">(</span><span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_sequence</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">safe</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">drop_sequences</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_sequences</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Metadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">primary_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">only_save_dirty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">depends_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">db_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">without_rowid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">temporary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legacy_table_names</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">__deprecated__</span><span class="p">(</span><span class="s1">&#39;&quot;db_table&quot; has been deprecated in favor of &#39;</span>
                           <span class="s1">&#39;&quot;table_name&quot; for Models.&#39;</span><span class="p">)</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="n">db_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combined</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span> <span class="o">=</span> <span class="n">_SortedFieldList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_field_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_by_name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_function</span> <span class="o">=</span> <span class="n">table_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legacy_table_names</span> <span class="o">=</span> <span class="n">legacy_table_names</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_function</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_function</span>
                          <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_table_name</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span> <span class="k">if</span> <span class="n">indexes</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="n">primary_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composite_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_increment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">only_save_dirty</span> <span class="o">=</span> <span class="n">only_save_dirty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depends_on</span> <span class="o">=</span> <span class="n">depends_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_settings</span> <span class="o">=</span> <span class="n">table_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">without_rowid</span> <span class="o">=</span> <span class="n">without_rowid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporary</span> <span class="o">=</span> <span class="n">temporary</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backrefs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_refs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_backrefs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manytomany</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Allow objects to register hooks that are called if the model is bound</span>
        <span class="c1"># to a different database. For example, BlobField uses a different</span>
        <span class="c1"># Python data-type depending on the db driver / python version. When</span>
        <span class="c1"># the database changes, we need to update any BlobField so they can use</span>
        <span class="c1"># the appropriate data-type.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_hooks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">make_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy_table_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w]+&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_snake_case</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">model_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backrefs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">depth_first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">refs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">backrefs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;One of `refs` or `backrefs` must be True.&#39;</span><span class="p">)</span>

        <span class="n">accum</span> <span class="o">=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">((</span><span class="bp">self</span><span class="p">,))</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span> <span class="k">if</span> <span class="n">depth_first</span> <span class="k">else</span> <span class="n">queue</span><span class="o">.</span><span class="n">popleft</span>

        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">method</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">refs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fk</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">curr</span><span class="o">.</span><span class="n">refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fk</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backrefs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fk</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">curr</span><span class="o">.</span><span class="n">backrefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fk</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">accum</span>

    <span class="k">def</span> <span class="nf">add_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_refs</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">rel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">backrefs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">rel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_backrefs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_refs</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">rel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">backrefs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="n">rel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_backrefs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_manytomany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manytomany</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

    <span class="k">def</span> <span class="nf">remove_manytomany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">manytomany</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
                <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">column_name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">],</span>
                <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
                <span class="n">_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">_database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>

    <span class="nd">@table</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot set the &quot;table&quot;.&#39;</span><span class="p">)</span>

    <span class="nd">@table</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span>

    <span class="nd">@schema</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">entity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_sorted_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_rel_for_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span>
        <span class="n">forwardrefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">backrefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_backrefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">forwardrefs</span><span class="p">,</span> <span class="n">backrefs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">set_attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manytomany</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_manytomany</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manytomany</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">MetaField</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>
            <span class="n">field</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_sorted_fields</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># This optimization helps speed up model instance construction.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>
                <span class="k">if</span> <span class="n">callable_</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_default_callables</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                        <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_default_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_default_by_name</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">set_attribute</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_ref</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ManyToManyField</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_manytomany</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>
        <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">original</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined</span><span class="p">[</span><span class="n">original</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_field_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_sorted_fields</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">original</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">original</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_callables</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">field_name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_by_name</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_ref</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_primary_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composite_key</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">CompositeKey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_increment</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">auto_increment</span> <span class="ow">or</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_primary_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">field_names</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="k">else</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_default_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_by_name</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_callable_list</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dd</span>

    <span class="k">def</span> <span class="nf">fields_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
                <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ModelIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,),</span> <span class="n">unique</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
                                          <span class="n">using</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">index_type</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">index_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_obj</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">index_parts</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="n">index_obj</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">index_parts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combined</span><span class="p">[</span><span class="n">part</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expected either a field name or a &#39;</span>
                                         <span class="s1">&#39;subclass of Node. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">part</span><span class="p">)</span>
                <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ModelIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">indexes</span>

    <span class="k">def</span> <span class="nf">set_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>

        <span class="c1"># Apply any hooks that have been registered.</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_hooks</span><span class="p">:</span>
            <span class="n">hook</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>


<span class="k">class</span> <span class="nc">SubclassAwareMetadata</span><span class="p">(</span><span class="n">Metadata</span><span class="p">):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SubclassAwareMetadata</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">map_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DoesNotExist</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ModelBase</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="n">inheritable</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;constraints&#39;</span><span class="p">,</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;indexes&#39;</span><span class="p">,</span> <span class="s1">&#39;primary_key&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="s1">&#39;table_function&#39;</span><span class="p">,</span> <span class="s1">&#39;temporary&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;only_save_dirty&#39;</span><span class="p">,</span> <span class="s1">&#39;legacy_table_names&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;table_settings&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">MODEL_BASE</span> <span class="ow">or</span> <span class="n">bases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">MODEL_BASE</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelBase</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="n">meta_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Meta&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                    <span class="n">meta_options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">pk</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;primary_key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">pk_name</span> <span class="o">=</span> <span class="n">parent_pk</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Inherit any field descriptors by deep copying the underlying field</span>
        <span class="c1"># into the attrs of the new model, additionally see if the bases define</span>
        <span class="c1"># inheritable model options and swipe them.</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">base_meta</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">_meta</span>
            <span class="k">if</span> <span class="n">parent_pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent_pk</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">base_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
            <span class="n">all_inheritable</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">inheritable</span> <span class="o">|</span> <span class="n">base_meta</span><span class="o">.</span><span class="n">_additional_keys</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">base_meta</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_inheritable</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta_options</span><span class="p">:</span>
                    <span class="n">meta_options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_meta</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">meta_options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="n">base_meta</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span> <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FieldAccessor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>

        <span class="n">sopts</span> <span class="o">=</span> <span class="n">meta_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;schema_options&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">Meta</span> <span class="o">=</span> <span class="n">meta_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_metadata_class&#39;</span><span class="p">,</span> <span class="n">Metadata</span><span class="p">)</span>
        <span class="n">Schema</span> <span class="o">=</span> <span class="n">meta_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_manager_class&#39;</span><span class="p">,</span> <span class="n">SchemaManager</span><span class="p">)</span>

        <span class="c1"># Construct the new class.</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelBase</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__data__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__rel__</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">meta_options</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">)</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="n">pk</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;over-determined primary key </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                    <span class="n">pk</span><span class="p">,</span> <span class="n">pk_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent_pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pk</span><span class="p">,</span> <span class="n">pk_name</span> <span class="o">=</span> <span class="p">((</span><span class="n">parent_pk</span><span class="p">,</span> <span class="n">parent_pk</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">parent_pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
                               <span class="p">(</span><span class="n">AutoField</span><span class="p">(),</span> <span class="s1">&#39;id&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">CompositeKey</span><span class="p">):</span>
            <span class="n">pk_name</span> <span class="o">=</span> <span class="s1">&#39;__composite_key__&#39;</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">composite_key</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">set_primary_key</span><span class="p">(</span><span class="n">pk_name</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="c1"># Create a repr and error class before finalizing.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__str__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;__repr__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__repr__&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()))</span>

        <span class="n">exc_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">DoesNotExist&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">exc_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;__module__&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">}</span>
        <span class="n">exception_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc_name</span><span class="p">,</span> <span class="p">(</span><span class="n">DoesNotExist</span><span class="p">,),</span> <span class="n">exc_attrs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">DoesNotExist</span> <span class="o">=</span> <span class="n">exception_class</span>

        <span class="c1"># Call validation hook, allowing additional model validation.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">validate_model</span><span class="p">()</span>
        <span class="n">DeferredForeignKey</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Model: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_by_id</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_by_id</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span>
    <span class="n">__nonzero__</span> <span class="o">=</span> <span class="fm">__bool__</span>  <span class="c1"># Python 2.</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_BoundModelsContext</span><span class="p">(</span><span class="n">_callable_context_manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">bind_refs</span><span class="p">,</span> <span class="n">bind_backrefs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_refs</span> <span class="o">=</span> <span class="n">bind_refs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_backrefs</span> <span class="o">=</span> <span class="n">bind_backrefs</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_database</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orig_database</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_refs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_backrefs</span><span class="p">,</span>
                       <span class="n">_exclude</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_database</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_refs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_backrefs</span><span class="p">,</span>
                       <span class="n">_exclude</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">ModelBase</span><span class="p">,</span> <span class="n">Node</span><span class="p">)):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__no_default__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__data__</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_default_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rel__</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelAlias</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">is_default</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">fields</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span>
        <span class="k">return</span> <span class="n">ModelSelect</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">is_default</span><span class="o">=</span><span class="n">is_default</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_normalize_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data cannot be mixed with keyword &#39;</span>
                                     <span class="s1">&#39;arguments: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span>
                             <span class="k">else</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">combined</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized field name: &quot;</span><span class="si">%s</span><span class="s1">&quot; in </span><span class="si">%s</span><span class="s1">.&#39;</span>
                                         <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">normalized</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">normalized</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">combined</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">normalized</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">normalized</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">__data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">update</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelUpdate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_normalize_data</span><span class="p">(</span><span class="n">__data</span><span class="p">,</span> <span class="n">update</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">__data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">insert</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelInsert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_normalize_data</span><span class="p">(</span><span class="n">__data</span><span class="p">,</span> <span class="n">insert</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_many</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelInsert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">insert</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_from</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
                   <span class="k">else</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ModelInsert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">insert</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">__data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">insert</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">__data</span><span class="p">,</span> <span class="o">**</span><span class="n">insert</span><span class="p">)</span><span class="o">.</span><span class="n">on_conflict</span><span class="p">(</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">replace_many</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span>
                <span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span>
                <span class="o">.</span><span class="n">on_conflict</span><span class="p">(</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelRaw</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelDelete</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">):</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">query</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force_insert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bulk_create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="n">chunked</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_list</span><span class="p">]</span>

        <span class="n">field_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_field_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_increment</span><span class="p">:</span>
            <span class="n">pk_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span>
            <span class="n">field_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pk_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">returning_clause</span> <span class="ow">and</span> \
           <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pk_fields</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_primary_keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_fields</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">]</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">):</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">object_id_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="n">accum</span> <span class="o">=</span> <span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pk_fields</span> <span class="ow">and</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">pk_field</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pk_fields</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pk_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bulk_update</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_list</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">CompositeKey</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bulk_update() is not supported for models with &#39;</span>
                             <span class="s1">&#39;a composite primary key.&#39;</span><span class="p">)</span>

        <span class="c1"># First normalize list of fields so all are field instances.</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span>
                  <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
        <span class="c1"># Now collect list of attribute names to use for values.</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">object_id_name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">)</span>
                 <span class="k">else</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="n">chunked</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_list</span><span class="p">]</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="n">id_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_pk</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
            <span class="n">update</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
                <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pk</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_pk</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">Case</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">accum</span><span class="p">)</span>
                <span class="n">update</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">case</span>

            <span class="n">n</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">id_list</span><span class="p">))</span>
                  <span class="o">.</span><span class="n">execute</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">n</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NoopModelSelect</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">):</span>
        <span class="n">sq</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="c1"># Handle simple lookup using just the primary key.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">sq</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">==</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sq</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">sq</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_or_none</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">==</span> <span class="n">pk</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_by_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">delete_by_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">==</span> <span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;defaults&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">defaults</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">dq_nodes</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">dq_nodes</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Using getattr(self, pk-name) could accidentally trigger a query if</span>
        <span class="c1"># the primary-key is a foreign-key. So we use the safe_name attribute,</span>
        <span class="c1"># which defaults to the field-name, but will be the object_id_name for</span>
        <span class="c1"># foreign-key fields.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">safe_name</span><span class="p">)</span>

    <span class="n">_pk</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_id</span><span class="p">)</span>

    <span class="nd">@_pk</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pk_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span>

    <span class="k">def</span> <span class="nf">_prune_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_dict</span><span class="p">,</span> <span class="n">only</span><span class="p">):</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">only</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">combined</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_dict</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">new_data</span>

    <span class="k">def</span> <span class="nf">_populate_unsaved_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">foreign_key_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">refs</span><span class="p">:</span>
            <span class="n">foreign_key</span> <span class="o">=</span> <span class="n">foreign_key_field</span><span class="o">.</span><span class="n">name</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">foreign_key</span> <span class="ow">in</span> <span class="n">field_dict</span> <span class="ow">and</span>
                <span class="n">field_dict</span><span class="p">[</span><span class="n">foreign_key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__rel__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">foreign_key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conditions</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foreign_key</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foreign_key</span><span class="p">))</span>
                <span class="n">field_dict</span><span class="p">[</span><span class="n">foreign_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="n">foreign_key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_insert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pk_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>
            <span class="n">pk_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_field</span> <span class="o">=</span> <span class="n">pk_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span><span class="n">field_dict</span><span class="p">,</span> <span class="n">only</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">only_save_dirty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_insert</span><span class="p">:</span>
            <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span><span class="n">field_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty_fields</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_unsaved_relations</span><span class="p">(</span><span class="n">field_dict</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_increment</span> <span class="ow">and</span> <span class="n">pk_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pk_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pk_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_insert</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pk_part_name</span> <span class="ow">in</span> <span class="n">pk_field</span><span class="o">.</span><span class="n">field_names</span><span class="p">:</span>
                    <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pk_part_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pk_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no data to save!&#39;</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">field_dict</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">())</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">pk_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="n">field_dict</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_increment</span> <span class="ow">or</span>
                                   <span class="n">pk_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="o">=</span> <span class="n">pk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="n">field_dict</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rows</span>

    <span class="k">def</span> <span class="nf">is_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">model_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">klass</span><span class="p">,</span> <span class="n">query</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fk</span><span class="p">,</span> <span class="n">rel_model</span> <span class="ow">in</span> <span class="n">klass</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">backrefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">rel_model</span> <span class="ow">is</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">fk</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="n">fk</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">fk</span> <span class="o">&lt;&lt;</span> <span class="n">query</span>
                <span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel_model</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fk</span><span class="o">.</span><span class="n">null</span> <span class="ow">or</span> <span class="n">search_nullable</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rel_model</span><span class="p">,</span> <span class="n">subquery</span><span class="p">))</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delete_nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">delete_nullable</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">query</span><span class="p">,</span> <span class="n">fk</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)):</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">model</span>
                <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delete_nullable</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fk</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">())</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_pk</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Value</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                             <span class="n">converter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">db_value</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">bind_refs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bind_backrefs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">is_different</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">database</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">set_database</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bind_refs</span> <span class="ow">or</span> <span class="n">bind_backrefs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_exclude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">G</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_graph</span><span class="p">(</span><span class="n">refs</span><span class="o">=</span><span class="n">bind_refs</span><span class="p">,</span> <span class="n">backrefs</span><span class="o">=</span><span class="n">bind_backrefs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">is_backref</span> <span class="ow">in</span> <span class="n">G</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_exclude</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">set_database</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
                    <span class="n">_exclude</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">is_different</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bind_ctx</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">bind_refs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bind_backrefs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_BoundModelsContext</span><span class="p">((</span><span class="bp">cls</span><span class="p">,),</span> <span class="n">database</span><span class="p">,</span> <span class="n">bind_refs</span><span class="p">,</span> <span class="n">bind_backrefs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">table_exists</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;fail_silently&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">__deprecated__</span><span class="p">(</span><span class="s1">&#39;&quot;fail_silently&quot; has been deprecated in favor of &#39;</span>
                           <span class="s1">&#39;&quot;safe&quot; for the create_table() method.&#39;</span><span class="p">)</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fail_silently&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">safe</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">safe_create_index</span> \
           <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">table_exists</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">temporary</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;temporary&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">temporary</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">safe</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">safe</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">safe_drop_index</span> \
           <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">table_exists</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">temporary</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;temporary&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">temporary</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">safe</span><span class="p">,</span> <span class="n">drop_sequences</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">truncate_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">truncate_table</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelIndex</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">SQL</span><span class="p">,</span> <span class="n">Index</span><span class="p">)):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ModelIndex</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ModelAlias</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide a separate reference to a model in a query.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="c1"># Hack to work-around the fact that properties or other objects</span>
        <span class="c1"># implementing the descriptor protocol (on the model being aliased),</span>
        <span class="c1"># will not work correctly when we use getattr(). So we explicitly pass</span>
        <span class="c1"># the model alias to the descriptor&#39;s getter.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ModelDescriptor</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">model_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_attr</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">FieldAlias</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_attr</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">model_attr</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot set attributes on model aliases.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_field_aliases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_field_names</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">:</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_aliases</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ModelSelect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_VALUES</span><span class="p">:</span>
            <span class="c1"># Return the quoted table name.</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span>

        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">SCOPE_SOURCE</span><span class="p">:</span>
            <span class="c1"># Define the table and its alias.</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ctx</span>
                    <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">entity</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Refer to the table using the alias.</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Entity</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="bp">self</span><span class="p">]))</span>


<span class="k">class</span> <span class="nc">FieldAlias</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">_FieldAlias</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">field</span><span class="p">)):</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">_FieldAlias</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FieldAlias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">db_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;model&#39;</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">column_name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">sort_models</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">foreign_key</span><span class="p">,</span> <span class="n">rel_model</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Do not depth-first search deferred foreign-keys as this can</span>
                <span class="c1"># cause tables to be created in the incorrect order.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
                    <span class="n">dfs</span><span class="p">(</span><span class="n">rel_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">depends_on</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">depends_on</span><span class="p">:</span>
                    <span class="n">dfs</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
            <span class="n">ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">names</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">names</span><span class="p">):</span>
        <span class="n">dfs</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ordering</span>


<span class="k">class</span> <span class="nc">_ModelQueryHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">default_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">MODEL</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_ModelQueryHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constructor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">CONSTRUCTOR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="n">constructor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">constructor</span>

    <span class="k">def</span> <span class="nf">_get_cursor_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="n">row_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_row_type</span>
        <span class="k">if</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">MODEL</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_cursor_wrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">DICT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ModelDictCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">TUPLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ModelTupleCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">NAMED_TUPLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ModelNamedTupleCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">row_type</span> <span class="o">==</span> <span class="n">ROW</span><span class="o">.</span><span class="n">CONSTRUCTOR</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ModelObjectCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized row type: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="n">row_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_model_cursor_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelObjectCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ModelRaw</span><span class="p">(</span><span class="n">_ModelQueryHelper</span><span class="p">,</span> <span class="n">RawQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelRaw</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> instance matching query does &#39;</span>
                                          <span class="s1">&#39;not exist:</span><span class="se">\n</span><span class="s1">SQL: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Params: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">BaseModelSelect</span><span class="p">(</span><span class="n">_ModelQueryHelper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">union_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelCompoundSelectQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;UNION ALL&#39;</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="fm">__add__</span> <span class="o">=</span> <span class="n">union_all</span>

    <span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelCompoundSelectQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;UNION&#39;</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="fm">__or__</span> <span class="o">=</span> <span class="n">union</span>

    <span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelCompoundSelectQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;INTERSECT&#39;</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="fm">__and__</span> <span class="o">=</span> <span class="n">intersect</span>

    <span class="k">def</span> <span class="nf">except_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ModelCompoundSelectQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EXCEPT&#39;</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="fm">__sub__</span> <span class="o">=</span> <span class="n">except_</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor_wrapper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">subqueries</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">subqueries</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">_cursor_wrapper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">clone</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">database</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> instance matching query does &#39;</span>
                                          <span class="s1">&#39;not exist:</span><span class="se">\n</span><span class="s1">SQL: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Params: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                          <span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">grouping</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_model</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
                <span class="n">grouping</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">column</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot pass a table to group_by() that &#39;</span>
                                     <span class="s1">&#39;does not have columns explicitly &#39;</span>
                                     <span class="s1">&#39;declared.&#39;</span><span class="p">)</span>
                <span class="n">grouping</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">col_name</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">_columns</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_by</span> <span class="o">=</span> <span class="n">grouping</span>


<span class="k">class</span> <span class="nc">ModelCompoundSelectQuery</span><span class="p">(</span><span class="n">BaseModelSelect</span><span class="p">,</span> <span class="n">CompoundSelectQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelCompoundSelectQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_model_cursor_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">_get_model_cursor_wrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_normalize_model_select</span><span class="p">(</span><span class="n">fields_or_models</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fields_or_models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_model</span><span class="p">(</span><span class="n">fm</span><span class="p">):</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">get_field_aliases</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fm</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">fm</span><span class="o">.</span><span class="n">_columns</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fields</span>


<span class="k">class</span> <span class="nc">ModelSelect</span><span class="p">(</span><span class="n">BaseModelSelect</span><span class="p">,</span> <span class="n">Select</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fields_or_models</span><span class="p">,</span> <span class="n">is_default</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_ctx</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_default</span> <span class="o">=</span> <span class="n">is_default</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">_normalize_model_select</span><span class="p">(</span><span class="n">fields_or_models</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelSelect</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([</span><span class="n">model</span><span class="p">],</span> <span class="n">fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelSelect</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clone</span><span class="o">.</span><span class="n">_joins</span><span class="p">:</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">_joins</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">_joins</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clone</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields_or_models</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fields_or_models</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_default</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">_normalize_model_select</span><span class="p">(</span><span class="n">fields_or_models</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelSelect</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">switch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_join_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ctx</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_model</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">src</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">src</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ModelSelect</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">src</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_normalize_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="c1"># Allow &quot;on&quot; expression to have an alias that determines the</span>
        <span class="c1"># destination attribute for the joined data.</span>
        <span class="n">on_alias</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="n">Alias</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">on_alias</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span> <span class="ow">or</span> <span class="n">on</span><span class="o">.</span><span class="n">_alias</span>
            <span class="n">on</span> <span class="o">=</span> <span class="n">on</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

        <span class="c1"># Obtain references to the source and destination models being joined.</span>
        <span class="n">src_model</span><span class="p">,</span> <span class="n">src_is_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">dest_model</span><span class="p">,</span> <span class="n">dest_is_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">src_model</span> <span class="ow">and</span> <span class="n">dest_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_join_ctx</span> <span class="o">=</span> <span class="n">dest</span>
            <span class="n">constructor</span> <span class="o">=</span> <span class="n">dest_model</span>

            <span class="c1"># In the case where the &quot;on&quot; clause is a Column or Field, we will</span>
            <span class="c1"># convert that field into the appropriate predicate expression.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">src_is_model</span> <span class="ow">and</span> <span class="n">dest_is_model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">on</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">to_field</span> <span class="o">=</span> <span class="n">src_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">on</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">on</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="n">dest</span><span class="p">:</span>
                    <span class="n">to_field</span> <span class="o">=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">on</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;&quot;on&quot; clause Column </span><span class="si">%s</span><span class="s1"> does not &#39;</span>
                                         <span class="s1">&#39;belong to </span><span class="si">%s</span><span class="s1"> or </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span>
                                         <span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="n">src_model</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">))</span>
                <span class="n">on</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="n">to_field</span> <span class="o">=</span> <span class="n">on</span>
                <span class="n">on</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_field</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">fk_field</span><span class="p">,</span> <span class="n">is_backref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_on_clause</span><span class="p">(</span>
                <span class="n">src_model</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">,</span> <span class="n">to_field</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">src_attr</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span> <span class="k">if</span> <span class="n">src_is_model</span> <span class="k">else</span> <span class="s1">&#39;column_name&#39;</span>
                <span class="n">dest_attr</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span> <span class="k">if</span> <span class="n">dest_is_model</span> <span class="k">else</span> <span class="s1">&#39;column_name&#39;</span>
                <span class="k">if</span> <span class="n">is_backref</span><span class="p">:</span>
                    <span class="n">lhs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fk_field</span><span class="p">,</span> <span class="n">dest_attr</span><span class="p">))</span>
                    <span class="n">rhs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fk_field</span><span class="o">.</span><span class="n">rel_field</span><span class="p">,</span> <span class="n">src_attr</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lhs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fk_field</span><span class="p">,</span> <span class="n">src_attr</span><span class="p">))</span>
                    <span class="n">rhs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fk_field</span><span class="o">.</span><span class="n">rel_field</span><span class="p">,</span> <span class="n">dest_attr</span><span class="p">))</span>
                <span class="n">on</span> <span class="o">=</span> <span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fk_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_backref</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">fk_field</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="n">on_alias</span> <span class="ow">and</span> <span class="n">fk_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                    <span class="n">attr</span> <span class="o">==</span> <span class="n">fk_field</span><span class="o">.</span><span class="n">object_id_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_backref</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot assign join alias to &quot;</span><span class="si">%s</span><span class="s1">&quot;, as this &#39;</span>
                                 <span class="s1">&#39;attribute is the object_id_name for the &#39;</span>
                                 <span class="s1">&#39;foreign-key field &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">fk_field</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="n">constructor</span> <span class="o">=</span> <span class="nb">dict</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span> <span class="ow">or</span> <span class="n">dest</span><span class="o">.</span><span class="n">_alias</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span> <span class="ow">or</span> <span class="n">dest</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">constructor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_on_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">to_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">_meta</span>
        <span class="n">is_backref</span> <span class="o">=</span> <span class="n">fk_fields</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get all the foreign keys between source and dest, and determine if</span>
        <span class="c1"># the join is via a back-reference.</span>
        <span class="k">if</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">model_refs</span><span class="p">:</span>
            <span class="n">fk_fields</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">model_refs</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">model_backrefs</span><span class="p">:</span>
            <span class="n">fk_fields</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">model_backrefs</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span>
            <span class="n">is_backref</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fk_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to find foreign key between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">. &#39;</span>
                             <span class="s1">&#39;Please specify an explicit join condition.&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">to_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If the foreign-key field was specified explicitly, remove all</span>
            <span class="c1"># other foreign-key fields from the list.</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_field</span><span class="o">.</span><span class="n">field</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_field</span><span class="p">,</span> <span class="n">FieldAlias</span><span class="p">)</span>
                      <span class="k">else</span> <span class="n">to_field</span><span class="p">)</span>
            <span class="n">fk_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fk_fields</span> <span class="k">if</span> <span class="p">(</span>
                         <span class="p">(</span><span class="n">f</span> <span class="ow">is</span> <span class="n">target</span><span class="p">)</span> <span class="ow">or</span>
                         <span class="p">(</span><span class="n">is_backref</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">rel_field</span> <span class="ow">is</span> <span class="n">to_field</span><span class="p">))]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fk_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fk_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">is_backref</span>

        <span class="k">if</span> <span class="n">on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If multiple foreign-keys exist, try using the FK whose name</span>
            <span class="c1"># matches that of the related model. If not, raise an error as this</span>
            <span class="c1"># is ambiguous.</span>
            <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">fk_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">dest</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">fk</span><span class="p">,</span> <span class="n">is_backref</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;More than one foreign key between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">.&#39;</span>
                             <span class="s1">&#39; Please specify which you are joining on.&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>

        <span class="c1"># If there are multiple foreign-keys to choose from and the join</span>
        <span class="c1"># predicate is an expression, we&#39;ll try to figure out which</span>
        <span class="c1"># foreign-key field we&#39;re joining on so that we can assign to the</span>
        <span class="c1"># correct attribute when resolving the model graph.</span>
        <span class="n">to_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">on</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">on</span><span class="o">.</span><span class="n">rhs</span>
            <span class="c1"># Coerce to set() so that we force Python to compare using the</span>
            <span class="c1"># object&#39;s hash rather than equality test, which returns a</span>
            <span class="c1"># false-positive due to overriding __eq__.</span>
            <span class="n">fk_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fk_fields</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="n">lhs_f</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">field</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">FieldAlias</span><span class="p">)</span> <span class="k">else</span> <span class="n">lhs</span>
                <span class="k">if</span> <span class="n">lhs_f</span> <span class="ow">in</span> <span class="n">fk_set</span><span class="p">:</span>
                    <span class="n">to_field</span> <span class="o">=</span> <span class="n">lhs_f</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="n">rhs_f</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">field</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FieldAlias</span><span class="p">)</span> <span class="k">else</span> <span class="n">rhs</span>
                <span class="k">if</span> <span class="n">rhs_f</span> <span class="ow">in</span> <span class="n">fk_set</span><span class="p">:</span>
                    <span class="n">to_field</span> <span class="o">=</span> <span class="n">rhs_f</span>

        <span class="k">return</span> <span class="n">to_field</span><span class="p">,</span> <span class="kc">False</span>

    <span class="nd">@Node</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="o">=</span><span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_ctx</span> <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">src</span>

        <span class="k">if</span> <span class="n">join_type</span> <span class="o">==</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LATERAL</span> <span class="ow">or</span> <span class="n">join_type</span> <span class="o">==</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_LATERAL</span><span class="p">:</span>
            <span class="n">on</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">join_type</span> <span class="o">!=</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">CROSS</span><span class="p">:</span>
            <span class="n">on</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">constructor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dest</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">join_type</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify on clause with cross join.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No sources to join on.&#39;</span><span class="p">)</span>

        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Join</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="p">,</span> <span class="n">on</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">join_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="o">=</span><span class="n">JOIN</span><span class="o">.</span><span class="n">INNER</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">join_type</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_model_cursor_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ModelObjectCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ModelCursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_from_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensure_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">join_kwargs</span><span class="p">):</span>
        <span class="n">join_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_ctx</span>
        <span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">dest</span> <span class="o">==</span> <span class="n">rm</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">lm</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">,</span> <span class="o">**</span><span class="n">join_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">join_ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert_dict_to_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qdict</span><span class="p">):</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">joins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fks</span> <span class="o">=</span> <span class="p">(</span><span class="n">ForeignKeyField</span><span class="p">,</span> <span class="n">BackrefAccessor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qdict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DJANGO_MAP</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">DJANGO_MAP</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">DJANGO_MAP</span><span class="p">[</span><span class="s1">&#39;is&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">DJANGO_MAP</span><span class="p">[</span><span class="s1">&#39;eq&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="c1"># Handle simplest case. This avoids joining over-eagerly when a</span>
                <span class="c1"># direct FK lookup is all that is required.</span>
                <span class="n">model_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">piece</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="p">()):</span>
                        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="n">piece</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">)</span> <span class="ow">and</span>
                                             <span class="n">dest</span><span class="o">.</span><span class="n">alias</span> <span class="o">==</span> <span class="n">piece</span><span class="p">):</span>
                            <span class="n">curr</span> <span class="o">=</span> <span class="n">dest</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">model_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">piece</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_attr</span><span class="p">,</span> <span class="n">fks</span><span class="p">):</span>
                            <span class="n">curr</span> <span class="o">=</span> <span class="n">model_attr</span><span class="o">.</span><span class="n">rel_model</span>
                            <span class="n">joins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_attr</span><span class="p">)</span>
            <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">model_attr</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">accum</span><span class="p">,</span> <span class="n">joins</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># normalize args and kwargs into a new expression</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">dq_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span> <span class="o">&amp;</span>
                       <span class="n">DQ</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">dq_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span> <span class="o">&amp;</span>
                       <span class="n">ColumnBase</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">dq_node</span> <span class="o">=</span> <span class="n">DQ</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ColumnBase</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="c1"># dq_node should now be an Expression, lhs = Node(), rhs = ...</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">([</span><span class="n">dq_node</span><span class="p">])</span>
        <span class="n">dq_joins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen_joins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">side</span><span class="p">,</span> <span class="n">piece</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;lhs&#39;</span><span class="p">,</span> <span class="n">curr</span><span class="o">.</span><span class="n">lhs</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rhs&#39;</span><span class="p">,</span> <span class="n">curr</span><span class="o">.</span><span class="n">rhs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">piece</span><span class="p">,</span> <span class="n">DQ</span><span class="p">):</span>
                    <span class="n">query</span><span class="p">,</span> <span class="n">joins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_dict_to_node</span><span class="p">(</span><span class="n">piece</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="n">joins</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">join</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_joins</span><span class="p">:</span>
                            <span class="n">dq_joins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="p">)</span>
                            <span class="n">seen_joins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">join</span><span class="p">)</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                    <span class="c1"># Apply values from the DQ object.</span>
                    <span class="k">if</span> <span class="n">piece</span><span class="o">.</span><span class="n">_negated</span><span class="p">:</span>
                        <span class="n">expression</span> <span class="o">=</span> <span class="n">Negated</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
                    <span class="c1">#expression._alias = piece._alias</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piece</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">dq_node</span> <span class="o">=</span> <span class="n">dq_node</span><span class="o">.</span><span class="n">lhs</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dq_joins</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKeyField</span><span class="p">):</span>
                <span class="n">lm</span><span class="p">,</span> <span class="n">rm</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>
                <span class="n">field_obj</span> <span class="o">=</span> <span class="n">field</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">BackrefAccessor</span><span class="p">):</span>
                <span class="n">lm</span><span class="p">,</span> <span class="n">rm</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_model</span>
                <span class="n">field_obj</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">field</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">ensure_join</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">field_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dq_node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">create_table_as</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">safe</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sql_selection__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">is_subquery</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_default</span> <span class="ow">and</span> <span class="n">is_subquery</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">CommaNodeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_returning</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">NoopModelSelect</span><span class="p">(</span><span class="n">ModelSelect</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__sql__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_noop_select</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cursor_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ModelWriteQueryHelper</span><span class="p">(</span><span class="n">_ModelQueryHelper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_ModelWriteQueryHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">returning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">returning</span><span class="p">):</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">returning</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_model</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_ModelWriteQueryHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="o">*</span><span class="n">accum</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_table_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="vm">__name__</span>


<span class="k">class</span> <span class="nc">ModelUpdate</span><span class="p">(</span><span class="n">_ModelWriteQueryHelper</span><span class="p">,</span> <span class="n">Update</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ModelInsert</span><span class="p">(</span><span class="n">_ModelWriteQueryHelper</span><span class="p">,</span> <span class="n">Insert</span><span class="p">):</span>
    <span class="n">default_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">TUPLE</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelInsert</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">returning_clause</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_returning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_primary_keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">returning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">returning</span><span class="p">):</span>
        <span class="c1"># By default ModelInsert will yield a `tuple` containing the</span>
        <span class="c1"># primary-key of the newly inserted row. But if we are explicitly</span>
        <span class="c1"># specifying a returning clause and have not set a row type, we will</span>
        <span class="c1"># default to returning model instances instead.</span>
        <span class="k">if</span> <span class="n">returning</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_row_type</span> <span class="o">=</span> <span class="n">ROW</span><span class="o">.</span><span class="n">MODEL</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelInsert</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="o">*</span><span class="n">returning</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_default_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">defaults</span>

    <span class="k">def</span> <span class="nf">get_default_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">sorted_fields</span>
        <span class="k">return</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_increment</span> <span class="k">else</span> <span class="n">fields</span>


<span class="k">class</span> <span class="nc">ModelDelete</span><span class="p">(</span><span class="n">_ModelWriteQueryHelper</span><span class="p">,</span> <span class="n">Delete</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ManyToManyQuery</span><span class="p">(</span><span class="n">ModelSelect</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">accessor</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span> <span class="o">=</span> <span class="n">accessor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_attr</span> <span class="o">=</span> <span class="n">accessor</span><span class="o">.</span><span class="n">src_fk</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dest_attr</span> <span class="o">=</span> <span class="n">accessor</span><span class="o">.</span><span class="n">dest_fk</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManyToManyQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="p">(</span><span class="n">rel</span><span class="p">,),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_id_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_or_id_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_id_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Model</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dest_attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">model_or_id_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">model_or_id_list</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">clear_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clear_existing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">accessor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span>
        <span class="n">src_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SelectQuery</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span>
                <span class="n">Value</span><span class="p">(</span><span class="n">src_id</span><span class="p">),</span>
                <span class="n">accessor</span><span class="o">.</span><span class="n">dest_fk</span><span class="o">.</span><span class="n">rel_field</span><span class="p">)</span>
            <span class="n">accessor</span><span class="o">.</span><span class="n">through_model</span><span class="o">.</span><span class="n">insert_from</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">accessor</span><span class="o">.</span><span class="n">src_fk</span><span class="p">,</span> <span class="n">accessor</span><span class="o">.</span><span class="n">dest_fk</span><span class="p">],</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">ensure_tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span> <span class="k">return</span>

            <span class="n">inserts</span> <span class="o">=</span> <span class="p">[{</span>
                <span class="n">accessor</span><span class="o">.</span><span class="n">src_fk</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">src_id</span><span class="p">,</span>
                <span class="n">accessor</span><span class="o">.</span><span class="n">dest_fk</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">rel_id</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">rel_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_list</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
            <span class="n">accessor</span><span class="o">.</span><span class="n">through_model</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">inserts</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">src_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SelectQuery</span><span class="p">):</span>
            <span class="n">column</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dest_attr</span><span class="p">)</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span><span class="o">.</span><span class="n">through_model</span>
                    <span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span><span class="o">.</span><span class="n">dest_fk</span> <span class="o">&lt;&lt;</span> <span class="n">subquery</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span><span class="o">.</span><span class="n">src_fk</span> <span class="o">==</span> <span class="n">src_id</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">execute</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">ensure_tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span><span class="o">.</span><span class="n">through_model</span>
                    <span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span><span class="o">.</span><span class="n">dest_fk</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_list</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span><span class="o">.</span><span class="n">src_fk</span> <span class="o">==</span> <span class="n">src_id</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">execute</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">src_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span><span class="o">.</span><span class="n">through_model</span>
                <span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accessor</span><span class="o">.</span><span class="n">src_fk</span> <span class="o">==</span> <span class="n">src_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">execute</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">safe_python_value</span><span class="p">(</span><span class="n">conv_func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">conv_func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">validate</span>


<span class="k">class</span> <span class="nc">BaseModelCursorWrapper</span><span class="p">(</span><span class="n">DictCursorWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseModelCursorWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="n">columns</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_initialize_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">combined</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="n">converters</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">description_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">description_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dot_index</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dot_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="p">[</span><span class="n">dot_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

            <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">raw_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">combined</span><span class="p">:</span>
                    <span class="n">raw_node</span> <span class="o">=</span> <span class="n">node</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">raw_node</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>

            <span class="c1"># Heuristics used to attempt to get the field associated with a</span>
            <span class="c1"># given SELECT column, so that we can accurately convert the value</span>
            <span class="c1"># returned by the database-cursor into a Python object.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_node</span><span class="o">.</span><span class="n">_coerce</span><span class="p">:</span>
                    <span class="n">converters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">python_value</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_node</span><span class="o">.</span><span class="n">is_alias</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ColumnBase</span><span class="p">)</span> <span class="ow">and</span> <span class="n">raw_node</span><span class="o">.</span><span class="n">_converter</span><span class="p">:</span>
                <span class="n">converters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_node</span><span class="o">.</span><span class="n">_converter</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">_coerce</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_python_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">converters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">_python_value</span>
                <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">arguments</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="c1"># If the first argument is a field or references a column</span>
                    <span class="c1"># on a Model, try using that field&#39;s conversion function.</span>
                    <span class="c1"># This usually works, but we use &quot;safe_python_value()&quot; so</span>
                    <span class="c1"># that if a TypeError or ValueError occurs during</span>
                    <span class="c1"># conversion we can just fall-back to the raw cursor value.</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Try to look-up by name.</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                        <span class="n">converters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_python_value</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">python_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">combined</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_coerce</span><span class="p">:</span>
                    <span class="n">converters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">python_value</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Column</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">table</span><span class="p">:</span>
                    <span class="n">fields</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>

    <span class="n">initialize</span> <span class="o">=</span> <span class="n">_initialize_columns</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">ModelDictCursorWrapper</span><span class="p">(</span><span class="n">BaseModelCursorWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">columns</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># Don&#39;t overwrite if we have dupes.</span>
            <span class="k">if</span> <span class="n">converters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">converters</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">ModelTupleCursorWrapper</span><span class="p">(</span><span class="n">ModelDictCursorWrapper</span><span class="p">):</span>
    <span class="n">constructor</span> <span class="o">=</span> <span class="nb">tuple</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">columns</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">([</span>
            <span class="p">(</span><span class="n">converters</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">converters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">)])</span>


<span class="k">class</span> <span class="nc">ModelNamedTupleCursorWrapper</span><span class="p">(</span><span class="n">ModelTupleCursorWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_columns</span><span class="p">()</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuple_class</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuple_class</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ModelObjectCursorWrapper</span><span class="p">(</span><span class="n">ModelDictCursorWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">constructor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">constructor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_model</span> <span class="o">=</span> <span class="n">is_model</span><span class="p">(</span><span class="n">constructor</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelObjectCursorWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">select</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelObjectCursorWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_model</span><span class="p">:</span>
            <span class="c1"># Clear out any dirty fields before returning to the user.</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="n">__no_default__</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ModelCursorWrapper</span><span class="p">(</span><span class="n">BaseModelCursorWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">from_list</span><span class="p">,</span> <span class="n">joins</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelCursorWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">select</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_list</span> <span class="o">=</span> <span class="n">from_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joins</span> <span class="o">=</span> <span class="n">joins</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_columns</span><span class="p">()</span>
        <span class="n">selected_src</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">field</span><span class="o">.</span><span class="n">model</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
                            <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">select</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">key_to_constructor</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_is_dest</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_to_dest</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_list</span><span class="p">)</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">accum</span><span class="p">:</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">accum</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">Join</span><span class="p">):</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">curr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joins</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">is_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">join_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joins</span><span class="p">[</span><span class="n">curr</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_to_constructor</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">key_to_constructor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">constructor</span>

                    <span class="c1"># (src, attr, dest, is_dict, join_type).</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">src_to_dest</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">is_dict</span><span class="p">,</span>
                                             <span class="n">join_type</span><span class="p">))</span>
                    <span class="n">dests</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Ensure that we accommodate everything selected.</span>
        <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">selected_src</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_to_constructor</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_model</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">key_to_constructor</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">key_to_constructor</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">model</span>

        <span class="c1"># Indicate which sources are also dests.</span>
        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_to_dest</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_is_dest</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">dests</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dest</span> <span class="ow">in</span> <span class="n">selected_src</span>
                                                      <span class="ow">or</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">selected_src</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">column_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">select</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">FieldAlias</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">source</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">source</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">column_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">object_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">constructor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_to_constructor</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">objects</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">constructor</span><span class="p">(</span><span class="n">__no_default__</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">object_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">set_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_keys</span><span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">set_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="n">idx</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">instance</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Need to do some analysis on the joins before this.</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">is_dict</span><span class="p">,</span> <span class="n">join_type</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_to_dest</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">joined_instance</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># If no fields were set on the destination instance then do not</span>
            <span class="c1"># assign an &quot;empty&quot; instance.</span>
            <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dest</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_is_dest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dest</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="c1"># If no fields were set on either the source or the destination,</span>
            <span class="c1"># then we have nothing to do here.</span>
            <span class="k">if</span> <span class="n">instance</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_keys</span> <span class="ow">and</span> <span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_keys</span> \
               <span class="ow">and</span> <span class="n">join_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;OUTER JOIN&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">is_dict</span><span class="p">:</span>
                <span class="n">instance</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">joined_instance</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">joined_instance</span><span class="p">)</span>

        <span class="c1"># When instantiating models from a cursor, we clear the dirty fields.</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">object_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">objects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">PrefetchQuery</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;_PrefetchQuery&#39;</span><span class="p">,</span> <span class="p">(</span>
    <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="s1">&#39;is_backref&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_models&#39;</span><span class="p">,</span> <span class="s1">&#39;field_to_name&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">))):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_backref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rel_models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">field_to_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_backref</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rel_models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rel_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
                <span class="n">foreign_key_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rel_models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rel_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">rel_model</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
                <span class="n">foreign_key_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
            <span class="n">field_to_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">foreign_key_attrs</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PrefetchQuery</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">is_backref</span><span class="p">,</span> <span class="n">rel_models</span><span class="p">,</span> <span class="n">field_to_name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">populate_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">id_map</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_backref</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">id_map</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">id_map</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">attname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_to_name</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
                <span class="n">rel_instances</span> <span class="o">=</span> <span class="n">id_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">rel_instances</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">attname</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">backref</span><span class="p">,</span> <span class="n">rel_instances</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">store_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">id_map</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">attname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_to_name</span><span class="p">:</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">python_value</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">__data__</span><span class="p">[</span><span class="n">attname</span><span class="p">])</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">identity</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_backref</span><span class="p">:</span>
                <span class="n">id_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">id_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">id_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prefetch_add_subquery</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">subqueries</span><span class="p">):</span>
    <span class="n">fixed_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrefetchQuery</span><span class="p">(</span><span class="n">sq</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subquery</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subqueries</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">subquery</span><span class="p">,</span> <span class="n">target_model</span> <span class="o">=</span> <span class="n">subquery</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">Query</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_model</span><span class="p">(</span><span class="n">subquery</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="nb">isinstance</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="n">subquery_model</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">model</span>
        <span class="n">fks</span> <span class="o">=</span> <span class="n">backrefs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed_queries</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">last_query</span> <span class="o">=</span> <span class="n">fixed</span><span class="o">.</span><span class="n">query</span>
            <span class="n">last_model</span> <span class="o">=</span> <span class="n">last_obj</span> <span class="o">=</span> <span class="n">fixed</span><span class="o">.</span><span class="n">model</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_model</span><span class="p">,</span> <span class="n">ModelAlias</span><span class="p">):</span>
                <span class="n">last_model</span> <span class="o">=</span> <span class="n">last_model</span><span class="o">.</span><span class="n">model</span>
            <span class="n">rels</span> <span class="o">=</span> <span class="n">subquery_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">last_model</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">rels</span><span class="p">:</span>
                <span class="n">fks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">subquery_model</span><span class="p">,</span> <span class="n">fk</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">rels</span><span class="p">]</span>
                <span class="n">pks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last_obj</span><span class="p">,</span> <span class="n">fk</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">rels</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">backrefs</span> <span class="o">=</span> <span class="n">subquery_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_backrefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">last_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fks</span> <span class="ow">or</span> <span class="n">backrefs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">target_model</span> <span class="ow">is</span> <span class="n">last_obj</span><span class="p">)</span> <span class="ow">or</span>
                                      <span class="p">(</span><span class="n">target_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">backrefs</span><span class="p">:</span>
            <span class="n">tgt_err</span> <span class="o">=</span> <span class="s1">&#39; using </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">target_model</span> <span class="k">if</span> <span class="n">target_model</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Error: unable to find foreign key for &#39;</span>
                                 <span class="s1">&#39;query: </span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">tgt_err</span><span class="p">))</span>

        <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_model</span><span class="p">,)</span> <span class="k">if</span> <span class="n">target_model</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">fks</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">fk</span> <span class="o">&lt;&lt;</span> <span class="n">last_query</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">fk</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fks</span><span class="p">,</span> <span class="n">pks</span><span class="p">)])</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">fixed_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PrefetchQuery</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">fks</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">backrefs</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">backref</span> <span class="ow">in</span> <span class="n">backrefs</span><span class="p">:</span>
                <span class="n">rel_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">subquery_model</span><span class="p">,</span> <span class="n">backref</span><span class="o">.</span><span class="n">rel_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">fk_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">last_obj</span><span class="p">,</span> <span class="n">backref</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_field</span> <span class="o">&lt;&lt;</span> <span class="n">last_query</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fk_field</span><span class="p">))</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="n">expressions</span><span class="p">))</span>
            <span class="n">fixed_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PrefetchQuery</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">backrefs</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fixed_queries</span>


<span class="k">def</span> <span class="nf">prefetch</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="o">*</span><span class="n">subqueries</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">subqueries</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sq</span>

    <span class="n">fixed_queries</span> <span class="o">=</span> <span class="n">prefetch_add_subquery</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">subqueries</span><span class="p">)</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rel_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pq</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">fixed_queries</span><span class="p">):</span>
        <span class="n">query_model</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">pq</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rel_model</span> <span class="ow">in</span> <span class="n">pq</span><span class="o">.</span><span class="n">rel_models</span><span class="p">:</span>
                <span class="n">rel_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rel_model</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">rel_map</span><span class="p">[</span><span class="n">rel_model</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq</span><span class="p">)</span>

        <span class="n">deps</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">query_model</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">id_map</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">query_model</span><span class="p">]</span>
        <span class="n">has_relations</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rel_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_model</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">pq</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pq</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">pq</span><span class="o">.</span><span class="n">store_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">id_map</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_relations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">rel_map</span><span class="p">[</span><span class="n">query_model</span><span class="p">]:</span>
                    <span class="n">rel</span><span class="o">.</span><span class="n">populate_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">deps</span><span class="p">[</span><span class="n">rel</span><span class="o">.</span><span class="n">model</span><span class="p">])</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">darc</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=JarryShaw&repo=darc&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../howto/index.html">How to </a></li>
<li class="toctree-l1"><a class="reference internal" href="../darc/index.html">Technical Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../custom.html">Customisations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker.html">Docker Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demo/api.html">Web Backend Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demo/model.html">Data Models Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demo/schema.html">Submission Data Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aux.html">Auxiliary Scripts</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019-2020, Jarry Shaw.
      
    </div>

    
    <a href="https://github.com/JarryShaw/darc" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>